<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.20" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const useChoice = localStorage.getItem('vuepress-color-scheme')
      const systemStatus =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (useChoice === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (useChoice === 'dark' || systemStatus) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>drf项目 | 笔记分析</title><meta name="description" content="即使是微小的进步,日积月累也会产生惊人的变化">
    <link rel="preload" href="/book/assets/style-QXEKf4Y2.css" as="style"><link rel="stylesheet" href="/book/assets/style-QXEKf4Y2.css">
    <link rel="modulepreload" href="/book/assets/app-D_gKCYhm.js"><link rel="modulepreload" href="/book/assets/39-drf项目.html-D4_wOmXu.js">
    <link rel="prefetch" href="/book/assets/index.html-C43sCsGc.js" as="script"><link rel="prefetch" href="/book/assets/01-node.html-CojAi_wJ.js" as="script"><link rel="prefetch" href="/book/assets/02-fs模块.html-a8Jnc5CT.js" as="script"><link rel="prefetch" href="/book/assets/03-模块化.html-egHgEBIH.js" as="script"><link rel="prefetch" href="/book/assets/04-模块管理.html-BlhjeqqV.js" as="script"><link rel="prefetch" href="/book/assets/05-http模块.html-q9boxCn6.js" as="script"><link rel="prefetch" href="/book/assets/06-express模块.html-BZkkKs6R.js" as="script"><link rel="prefetch" href="/book/assets/07-koa模块.html-cP_SOf9K.js" as="script"><link rel="prefetch" href="/book/assets/08-mongoose.html-8AYXGoWL.js" as="script"><link rel="prefetch" href="/book/assets/09-mysql.html-iblRTeG8.js" as="script"><link rel="prefetch" href="/book/assets/cookie跨域问题.html-6NAkTVJm.js" as="script"><link rel="prefetch" href="/book/assets/index.html-DfZb95ae.js" as="script"><link rel="prefetch" href="/book/assets/模块补充.html-9IwuXlma.js" as="script"><link rel="prefetch" href="/book/assets/知识补充.html--C5p0b_W.js" as="script"><link rel="prefetch" href="/book/assets/阿里云程知识.html-DTfGyuKo.js" as="script"><link rel="prefetch" href="/book/assets/01-开班学习.html-CwcKcXzK.js" as="script"><link rel="prefetch" href="/book/assets/02-基础标签.html-DwHUYB3h.js" as="script"><link rel="prefetch" href="/book/assets/03-css基础知识.html-BZtFPSVy.js" as="script"><link rel="prefetch" href="/book/assets/04-盒模型.html-NzCtC4w9.js" as="script"><link rel="prefetch" href="/book/assets/05-元素类型.html-R3chngnv.js" as="script"><link rel="prefetch" href="/book/assets/06-文本文字属性.html-CqabbcyX.js" as="script"><link rel="prefetch" href="/book/assets/07-背景属性.html-BGP2l8Ro.js" as="script"><link rel="prefetch" href="/book/assets/08-圆角、透明、渐变、鼠标.html-BEAbfUZ5.js" as="script"><link rel="prefetch" href="/book/assets/09-浮动.html-pEMObg7A.js" as="script"><link rel="prefetch" href="/book/assets/10-定位.html-J-irx0oE.js" as="script"><link rel="prefetch" href="/book/assets/11-表单与表格.html-Bu6u94ZQ.js" as="script"><link rel="prefetch" href="/book/assets/12-选择器高级.html-DBFA3Mdw.js" as="script"><link rel="prefetch" href="/book/assets/13-过渡与动画.html-BSnMMpiC.js" as="script"><link rel="prefetch" href="/book/assets/14-transform变形.html-BlKndjgl.js" as="script"><link rel="prefetch" href="/book/assets/15-弹性盒模型.html-BjbtPHt-.js" as="script"><link rel="prefetch" href="/book/assets/16-响应式布局、阿里图标等.html-B5r1gRxD.js" as="script"><link rel="prefetch" href="/book/assets/17-网格布局.html-CZMwHsKu.js" as="script"><link rel="prefetch" href="/book/assets/HTML_CSS规范.html-mMmAlgkd.js" as="script"><link rel="prefetch" href="/book/assets/index.html-DGXwE8lY.js" as="script"><link rel="prefetch" href="/book/assets/补充.html-CNdPLit4.js" as="script"><link rel="prefetch" href="/book/assets/01-web服务器.html--QHSlYpa.js" as="script"><link rel="prefetch" href="/book/assets/02-django介绍.html-CSQ2pfGn.js" as="script"><link rel="prefetch" href="/book/assets/03-路由层.html-Cgrk84bS.js" as="script"><link rel="prefetch" href="/book/assets/04-路由层和视图层.html-8fZYM-iX.js" as="script"><link rel="prefetch" href="/book/assets/05-视图层.html-BwFM6NgQ.js" as="script"><link rel="prefetch" href="/book/assets/06-模板层.html-DPzeMikE.js" as="script"><link rel="prefetch" href="/book/assets/07-orm.html-8gzN48Un.js" as="script"><link rel="prefetch" href="/book/assets/08-orm.html-D2V5Wmtu.js" as="script"><link rel="prefetch" href="/book/assets/09-orm.html-Q0dDNO5r.js" as="script"><link rel="prefetch" href="/book/assets/10-orm.html-CVfX4yS2.js" as="script"><link rel="prefetch" href="/book/assets/11-orm.html-DpbS0bJ9.js" as="script"><link rel="prefetch" href="/book/assets/12-图书管理系统.html-D3-1Gsyq.js" as="script"><link rel="prefetch" href="/book/assets/13-图书管理系统.html-COjkS0El.js" as="script"><link rel="prefetch" href="/book/assets/14-ajax.html-cZWgfqw2.js" as="script"><link rel="prefetch" href="/book/assets/15-form组件.html-BfVbLdkq.js" as="script"><link rel="prefetch" href="/book/assets/16-forms组件.html-m4ROEk5p.js" as="script"><link rel="prefetch" href="/book/assets/17-cookie和session.html-C9nYIvcJ.js" as="script"><link rel="prefetch" href="/book/assets/18-django中间件.html-BrWIqzAG.js" as="script"><link rel="prefetch" href="/book/assets/19-auth模块.html-BIFhreCo.js" as="script"><link rel="prefetch" href="/book/assets/20-博客园项目.html-Dx53dew0.js" as="script"><link rel="prefetch" href="/book/assets/21-博客园项目.html-D56gpQZL.js" as="script"><link rel="prefetch" href="/book/assets/22-博客园项目.html-B9P3NZDk.js" as="script"><link rel="prefetch" href="/book/assets/23-博客园项目.html-CZV5OQaf.js" as="script"><link rel="prefetch" href="/book/assets/24-博客园项目.html-UmDeBiAT.js" as="script"><link rel="prefetch" href="/book/assets/25-博客园项目.html-rAGw74nN.js" as="script"><link rel="prefetch" href="/book/assets/26-博客园项目.html-DAYfnWWU.js" as="script"><link rel="prefetch" href="/book/assets/27-博客园项目.html-Bi9MmqNw.js" as="script"><link rel="prefetch" href="/book/assets/28-linux基础.html-CkJkY-ID.js" as="script"><link rel="prefetch" href="/book/assets/32-restful规范.html-DCVQ_cTs.js" as="script"><link rel="prefetch" href="/book/assets/33-drf介绍.html-BZz2-8Zv.js" as="script"><link rel="prefetch" href="/book/assets/34-drf框架.html-qH5VEScI.js" as="script"><link rel="prefetch" href="/book/assets/35-drf框架.html-Bn54_Rhf.js" as="script"><link rel="prefetch" href="/book/assets/36-drf框架.html-C0Snia8F.js" as="script"><link rel="prefetch" href="/book/assets/37-drf框架.html-DZH2B3WF.js" as="script"><link rel="prefetch" href="/book/assets/38-drf框架.html-uk5Ci2U3.js" as="script"><link rel="prefetch" href="/book/assets/index.html-CddHOiwH.js" as="script"><link rel="prefetch" href="/book/assets/01-认识JavaScript.html-BptdpuVD.js" as="script"><link rel="prefetch" href="/book/assets/02-初学Javscript类型.html-Jenxrdz8.js" as="script"><link rel="prefetch" href="/book/assets/03-运算符.html-DED6bxUo.js" as="script"><link rel="prefetch" href="/book/assets/04-控制流程.html-CbRIa7wj.js" as="script"><link rel="prefetch" href="/book/assets/05-循环.html-w3nVdBcb.js" as="script"><link rel="prefetch" href="/book/assets/06-函数.html-DNOWzBN3.js" as="script"><link rel="prefetch" href="/book/assets/07-作用域.html-5y_JAYL6.js" as="script"><link rel="prefetch" href="/book/assets/08-字符串与数组.html-B0WAin2K.js" as="script"><link rel="prefetch" href="/book/assets/09-定时器_Math.html-D0yzUDmN.js" as="script"><link rel="prefetch" href="/book/assets/10-日期对象.html-BWN686CK.js" as="script"><link rel="prefetch" href="/book/assets/11-ES6解构与扩展.html-CSn85Mt9.js" as="script"><link rel="prefetch" href="/book/assets/12-DOM基础.html-BiSwhRkU.js" as="script"><link rel="prefetch" href="/book/assets/13-DOM与BOM.html-DM7DdFv4.js" as="script"><link rel="prefetch" href="/book/assets/14-事件.html-DdQfvn-U.js" as="script"><link rel="prefetch" href="/book/assets/15-json与对象.html-dZ-6hWys.js" as="script"><link rel="prefetch" href="/book/assets/16-正则表达式.html-Mqsg-bnq.js" as="script"><link rel="prefetch" href="/book/assets/17-构造函数.html-BG64zKn5.js" as="script"><link rel="prefetch" href="/book/assets/18-Class类.html-31fPDgym.js" as="script"><link rel="prefetch" href="/book/assets/19-promise和async.html-BZdrZJZm.js" as="script"><link rel="prefetch" href="/book/assets/20-ajax.html-DSLpoeyq.js" as="script"><link rel="prefetch" href="/book/assets/21-本地存储.html-Chx_WUy2.js" as="script"><link rel="prefetch" href="/book/assets/22-补充录播.html-Cy7RO-bK.js" as="script"><link rel="prefetch" href="/book/assets/23-补充录播代理.html-66Oea21q.js" as="script"><link rel="prefetch" href="/book/assets/index.html-DXoxZ84K.js" as="script"><link rel="prefetch" href="/book/assets/严格模式.html-CcbTkawS.js" as="script"><link rel="prefetch" href="/book/assets/时间线_异步加载.html-DhVuekwL.js" as="script"><link rel="prefetch" href="/book/assets/知识补充.html-DIdYk74Y.js" as="script"><link rel="prefetch" href="/book/assets/archive1.html-22jGSncr.js" as="script"><link rel="prefetch" href="/book/assets/01-python基础.html-CmwpJUDC.js" as="script"><link rel="prefetch" href="/book/assets/02-基本数据类型与变量.html-C2cZ3vbB.js" as="script"><link rel="prefetch" href="/book/assets/03-用户交互与运算符.html-Cn8Mpwqz.js" as="script"><link rel="prefetch" href="/book/assets/04-流程控制-上.html-LEhuw1bO.js" as="script"><link rel="prefetch" href="/book/assets/05-流程控制-下.html-CGmFPkZl.js" as="script"><link rel="prefetch" href="/book/assets/06_序列类型-字符串.html-CFl7jdrC.js" as="script"><link rel="prefetch" href="/book/assets/07_序列类型-列表_元组.html-D1SyUNBn.js" as="script"><link rel="prefetch" href="/book/assets/08_散列类型-字典与集合.html-D2kouDG7.js" as="script"><link rel="prefetch" href="/book/assets/09_函数基础上.html-CLzKaDoZ.js" as="script"><link rel="prefetch" href="/book/assets/10_函数基础下.html-J1QymbM8.js" as="script"><link rel="prefetch" href="/book/assets/11_作用域与匿名函数.html-D0fCKT-x.js" as="script"><link rel="prefetch" href="/book/assets/12_匿名函数_内置高阶函数.html-CXUVzNEZ.js" as="script"><link rel="prefetch" href="/book/assets/13_装饰器_迭代器_生成器.html-BCPiJ4Jd.js" as="script"><link rel="prefetch" href="/book/assets/14_文件操作.html-BVeSKqnS.js" as="script"><link rel="prefetch" href="/book/assets/15_模块与包.html-Deq_cXNE.js" as="script"><link rel="prefetch" href="/book/assets/16_第三方模块与常用模块.html-B4ZbO3Ac.js" as="script"><link rel="prefetch" href="/book/assets/17_初识面向对象.html-C5OnnVEj.js" as="script"><link rel="prefetch" href="/book/assets/18_面向对象三大特征—封装.html-BvkTd-IL.js" as="script"><link rel="prefetch" href="/book/assets/19_面向对象三大特征—继承_多态.html-VlY9Etkm.js" as="script"><link rel="prefetch" href="/book/assets/20_绑定方法_内置方法_异常.html-v7W1ApQQ.js" as="script"><link rel="prefetch" href="/book/assets/21_网络编程基础.html-B7eLl2mY.js" as="script"><link rel="prefetch" href="/book/assets/22_socket套接字.html-DLrl9Dzs.js" as="script"><link rel="prefetch" href="/book/assets/23_非阻塞_IO多路复用.html-9nXFkydw.js" as="script"><link rel="prefetch" href="/book/assets/24_粘包_网盘项目.html-CwNgzWMW.js" as="script"><link rel="prefetch" href="/book/assets/index.html-kQ1ixXAm.js" as="script"><link rel="prefetch" href="/book/assets/网盘项目.html-ztjFvcPa.js" as="script"><link rel="prefetch" href="/book/assets/01-react.html-C5Li4KqO.js" as="script"><link rel="prefetch" href="/book/assets/02-函数组件.html-BNxkVsea.js" as="script"><link rel="prefetch" href="/book/assets/03-函数基础.html-D1IYbV9K.js" as="script"><link rel="prefetch" href="/book/assets/04-组件通信.html-CN5EmPcG.js" as="script"><link rel="prefetch" href="/book/assets/05-类组件的使用.html-BW4sLyhI.js" as="script"><link rel="prefetch" href="/book/assets/06-脚手架.html-BYR4S5G-.js" as="script"><link rel="prefetch" href="/book/assets/07-hook函数.html-DZrVDF8I.js" as="script"><link rel="prefetch" href="/book/assets/08-router.html-sSjwFauI.js" as="script"><link rel="prefetch" href="/book/assets/09-reduc.html-D1usYXTD.js" as="script"><link rel="prefetch" href="/book/assets/index.html-cWv1SzyV.js" as="script"><link rel="prefetch" href="/book/assets/01-爬虫简介.html-Dtx0iuFN.js" as="script"><link rel="prefetch" href="/book/assets/02-requests请求.html-0i2YRtiZ.js" as="script"><link rel="prefetch" href="/book/assets/03-正则.html-D_bz8eLj.js" as="script"><link rel="prefetch" href="/book/assets/04-解析数据.html-BJ4_E3Qy.js" as="script"><link rel="prefetch" href="/book/assets/05-selenium.html-BjoJvdLA.js" as="script"><link rel="prefetch" href="/book/assets/06-DrissionPage.html-Y3kambD4.js" as="script"><link rel="prefetch" href="/book/assets/07-进程和线程与协程.html-CjYzxHEO.js" as="script"><link rel="prefetch" href="/book/assets/08-fiddler.html--YyRZojH.js" as="script"><link rel="prefetch" href="/book/assets/09-Scrapy.html-DT5aNfUE.js" as="script"><link rel="prefetch" href="/book/assets/10-scrapy分布式.html-C0xkzcij.js" as="script"><link rel="prefetch" href="/book/assets/11-Elasticsearch.html-tTN25aDn.js" as="script"><link rel="prefetch" href="/book/assets/12-js逆向-01.html-DY66y5zU.js" as="script"><link rel="prefetch" href="/book/assets/12-js逆向-02.html-fEHfi83t.js" as="script"><link rel="prefetch" href="/book/assets/13-逆向案例.html-DdVbLAwP.js" as="script"><link rel="prefetch" href="/book/assets/index.html-BskWU64F.js" as="script"><link rel="prefetch" href="/book/assets/补充.html-CuC4JRfY.js" as="script"><link rel="prefetch" href="/book/assets/index.html-Bt9kK6Zj.js" as="script"><link rel="prefetch" href="/book/assets/vite-vueCli.html-CQH4xHr6.js" as="script"><link rel="prefetch" href="/book/assets/vue3-01开始.html-DsEptBh6.js" as="script"><link rel="prefetch" href="/book/assets/vue3-02指令.html-CcEuls0z.js" as="script"><link rel="prefetch" href="/book/assets/vue3-03响应式数据.html-DqN2Z3mr.js" as="script"><link rel="prefetch" href="/book/assets/vue3-04选项式API.html-nCkuv2N3.js" as="script"><link rel="prefetch" href="/book/assets/vue3-05组件-脚手架-生命周期.html-C3Qf0coz.js" as="script"><link rel="prefetch" href="/book/assets/vue3-06组件与传值.html-CFBLbUob.js" as="script"><link rel="prefetch" href="/book/assets/vue3-07内置内容.html-CoGFQ-im.js" as="script"><link rel="prefetch" href="/book/assets/vue3-08vuex.html-Da_UhUCC.js" as="script"><link rel="prefetch" href="/book/assets/vue3-10组合式基础.html-BBPMT5zG.js" as="script"><link rel="prefetch" href="/book/assets/vue3-11组合式内置.html-C3nOhm3N.js" as="script"><link rel="prefetch" href="/book/assets/vue3-12组合式API.html-B4xQG4en.js" as="script"><link rel="prefetch" href="/book/assets/vue3-13pinia.html-BcdW1Fjq.js" as="script"><link rel="prefetch" href="/book/assets/vue3-9Router.html-eEH6Icpj.js" as="script"><link rel="prefetch" href="/book/assets/vue推荐风格.html-BEXI08iz.js" as="script"><link rel="prefetch" href="/book/assets/vue补充内容.html-Cwkt7AJq.js" as="script"><link rel="prefetch" href="/book/assets/配置文件.html-BJ4LWAor.js" as="script"><link rel="prefetch" href="/book/assets/404.html-73AvNA8G.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/book/"><!----><span class="vp-site-name" aria-hidden="true">笔记分析</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/htmlcss/" aria-label="HTML/CSS"><!--[--><!--[--><!--]--><!--]-->HTML/CSS<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/javaScript/" aria-label="JavaScript"><!--[--><!--[--><!--]--><!--]-->JavaScript<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/node/" aria-label="Node"><!--[--><!--[--><!--]--><!--]-->Node<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/vue/" aria-label="Vue"><!--[--><!--[--><!--]--><!--]-->Vue<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/react/" aria-label="React"><!--[--><!--[--><!--]--><!--]-->React<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/python/" aria-label="Python"><!--[--><!--[--><!--]--><!--]-->Python<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/book/django/" aria-label="Django"><!--[--><!--[--><!--]--><!--]-->Django<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/spider/" aria-label="Spider"><!--[--><!--[--><!--]--><!--]-->Spider<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/htmlcss/" aria-label="HTML/CSS"><!--[--><!--[--><!--]--><!--]-->HTML/CSS<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/javaScript/" aria-label="JavaScript"><!--[--><!--[--><!--]--><!--]-->JavaScript<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/node/" aria-label="Node"><!--[--><!--[--><!--]--><!--]-->Node<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/vue/" aria-label="Vue"><!--[--><!--[--><!--]--><!--]-->Vue<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/react/" aria-label="React"><!--[--><!--[--><!--]--><!--]-->React<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/python/" aria-label="Python"><!--[--><!--[--><!--]--><!--]-->Python<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link route-link-active auto-link" href="/book/django/" aria-label="Django"><!--[--><!--[--><!--]--><!--]-->Django<!--[--><!--[--><!--]--><!--]--></a></div><div class="vp-navbar-item"><a class="route-link auto-link" href="/book/spider/" aria-label="Spider"><!--[--><!--[--><!--]--><!--]-->Spider<!--[--><!--[--><!--]--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/01-web%E6%9C%8D%E5%8A%A1%E5%99%A8.html" aria-label="01-web服务器"><!--[--><!--[--><!--]--><!--]-->01-web服务器<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/02-django%E4%BB%8B%E7%BB%8D.html" aria-label="02-django介绍"><!--[--><!--[--><!--]--><!--]-->02-django介绍<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/03-%E8%B7%AF%E7%94%B1%E5%B1%82.html" aria-label="03-路由层"><!--[--><!--[--><!--]--><!--]-->03-路由层<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/04-%E8%B7%AF%E7%94%B1%E5%B1%82%E5%92%8C%E8%A7%86%E5%9B%BE%E5%B1%82.html" aria-label="04-路由层和视图层"><!--[--><!--[--><!--]--><!--]-->04-路由层和视图层<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/05-%E8%A7%86%E5%9B%BE%E5%B1%82.html" aria-label="05-视图层"><!--[--><!--[--><!--]--><!--]-->05-视图层<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/06-%E6%A8%A1%E6%9D%BF%E5%B1%82.html" aria-label="06-模板层"><!--[--><!--[--><!--]--><!--]-->06-模板层<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/07-orm.html" aria-label="07-orm"><!--[--><!--[--><!--]--><!--]-->07-orm<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/08-orm.html" aria-label="08-orm"><!--[--><!--[--><!--]--><!--]-->08-orm<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/09-orm.html" aria-label="09-orm"><!--[--><!--[--><!--]--><!--]-->09-orm<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/10-orm.html" aria-label="10-orm"><!--[--><!--[--><!--]--><!--]-->10-orm<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/11-orm.html" aria-label="11-orm"><!--[--><!--[--><!--]--><!--]-->11-orm<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/12-%E5%9B%BE%E4%B9%A6%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F.html" aria-label="12-图书管理系统"><!--[--><!--[--><!--]--><!--]-->12-图书管理系统<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/13-%E5%9B%BE%E4%B9%A6%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F.html" aria-label="13-图书管理系统"><!--[--><!--[--><!--]--><!--]-->13-图书管理系统<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/14-ajax.html" aria-label="14-ajax"><!--[--><!--[--><!--]--><!--]-->14-ajax<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/15-form%E7%BB%84%E4%BB%B6.html" aria-label="15-form组件"><!--[--><!--[--><!--]--><!--]-->15-form组件<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/16-forms%E7%BB%84%E4%BB%B6.html" aria-label="16-forms组件"><!--[--><!--[--><!--]--><!--]-->16-forms组件<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/17-cookie%E5%92%8Csession.html" aria-label="17-cookie和session"><!--[--><!--[--><!--]--><!--]-->17-cookie和session<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/18-django%E4%B8%AD%E9%97%B4%E4%BB%B6.html" aria-label="18-django中间件"><!--[--><!--[--><!--]--><!--]-->18-django中间件<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/19-auth%E6%A8%A1%E5%9D%97.html" aria-label="19-auth模块"><!--[--><!--[--><!--]--><!--]-->19-auth模块<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/20-%E5%8D%9A%E5%AE%A2%E5%9B%AD%E9%A1%B9%E7%9B%AE.html" aria-label="20-博客园项目"><!--[--><!--[--><!--]--><!--]-->20-博客园项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/21-%E5%8D%9A%E5%AE%A2%E5%9B%AD%E9%A1%B9%E7%9B%AE.html" aria-label="21-博客园项目"><!--[--><!--[--><!--]--><!--]-->21-博客园项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/22-%E5%8D%9A%E5%AE%A2%E5%9B%AD%E9%A1%B9%E7%9B%AE.html" aria-label="22-博客园项目"><!--[--><!--[--><!--]--><!--]-->22-博客园项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/23-%E5%8D%9A%E5%AE%A2%E5%9B%AD%E9%A1%B9%E7%9B%AE.html" aria-label="23-博客园项目"><!--[--><!--[--><!--]--><!--]-->23-博客园项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/24-%E5%8D%9A%E5%AE%A2%E5%9B%AD%E9%A1%B9%E7%9B%AE.html" aria-label="24-博客园项目"><!--[--><!--[--><!--]--><!--]-->24-博客园项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/25-%E5%8D%9A%E5%AE%A2%E5%9B%AD%E9%A1%B9%E7%9B%AE.html" aria-label="25-博客园项目"><!--[--><!--[--><!--]--><!--]-->25-博客园项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/26-%E5%8D%9A%E5%AE%A2%E5%9B%AD%E9%A1%B9%E7%9B%AE.html" aria-label="26-博客园项目"><!--[--><!--[--><!--]--><!--]-->26-博客园项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/27-%E5%8D%9A%E5%AE%A2%E5%9B%AD%E9%A1%B9%E7%9B%AE.html" aria-label="27-博客园项目"><!--[--><!--[--><!--]--><!--]-->27-博客园项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/28-linux%E5%9F%BA%E7%A1%80.html" aria-label="28-linux基础"><!--[--><!--[--><!--]--><!--]-->28-linux基础<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/32-restful%E8%A7%84%E8%8C%83.html" aria-label="32-restful规范"><!--[--><!--[--><!--]--><!--]-->32-restful规范<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/33-drf%E4%BB%8B%E7%BB%8D.html" aria-label="33-drf介绍"><!--[--><!--[--><!--]--><!--]-->33-drf介绍<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/34-drf%E6%A1%86%E6%9E%B6.html" aria-label="34-drf框架"><!--[--><!--[--><!--]--><!--]-->34-drf框架<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/35-drf%E6%A1%86%E6%9E%B6.html" aria-label="35-drf框架"><!--[--><!--[--><!--]--><!--]-->35-drf框架<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/36-drf%E6%A1%86%E6%9E%B6.html" aria-label="36-drf框架"><!--[--><!--[--><!--]--><!--]-->36-drf框架<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/37-drf%E6%A1%86%E6%9E%B6.html" aria-label="37-drf框架"><!--[--><!--[--><!--]--><!--]-->37-drf框架<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link auto-link vp-sidebar-item vp-sidebar-heading" href="/book/django/38-drf%E6%A1%86%E6%9E%B6.html" aria-label="38-drf框架"><!--[--><!--[--><!--]--><!--]-->38-drf框架<!--[--><!--[--><!--]--><!--]--></a><!----></li><li><a class="route-link route-link-active auto-link vp-sidebar-item vp-sidebar-heading active" href="/book/django/39-drf%E9%A1%B9%E7%9B%AE.html" aria-label="39-drf项目"><!--[--><!--[--><!--]--><!--]-->39-drf项目<!--[--><!--[--><!--]--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div vp-content><!--[--><!--]--><div><h1 id="drf项目" tabindex="-1"><a class="header-anchor" href="#drf项目"><span>drf项目</span></a></h1><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">注册</span>
<span class="line">	手机号<span class="token punctuation">,</span> 用户名<span class="token punctuation">,</span> 密码<span class="token punctuation">,</span> 确认密码</span>
<span class="line"></span>
<span class="line">登录</span>
<span class="line">	手机号或者用户名 <span class="token operator">+</span> 密码</span>
<span class="line">    登录成功返回token<span class="token punctuation">,</span>后续登录校验需要携带token</span>
<span class="line">    </span>
<span class="line">我的话题</span>
<span class="line">	话题列表<span class="token punctuation">,</span> 添加话题<span class="token punctuation">,</span> 修改话题<span class="token punctuation">,</span> 删除话题</span>
<span class="line">    </span>
<span class="line">首页</span>
<span class="line">	所有资讯</span>
<span class="line">    	<span class="token operator">-</span>时间倒序<span class="token punctuation">,</span>读取已经通过审核的资讯</span>
<span class="line">        <span class="token operator">-</span>进行分页</span>
<span class="line">        <span class="token punctuation">(</span>如果我访问第一个展示<span class="token number">100</span><span class="token operator">-</span><span class="token number">91</span>条数据<span class="token punctuation">,</span> 第二次展示<span class="token number">90</span><span class="token operator">-</span><span class="token number">81</span>条<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">        	如果此时数据库又新增了一条资讯会变成<span class="token punctuation">:</span>访问<span class="token number">101</span><span class="token operator">-</span><span class="token number">92</span>条<span class="token punctuation">,</span>不往回走</span>
<span class="line">        <span class="token punctuation">)</span></span>
<span class="line">          </span>
<span class="line">	</span>
<span class="line">个人页</span>
<span class="line">	展示我的资讯列表</span>
<span class="line">    创建资讯<span class="token punctuation">(</span><span class="token number">5</span>分钟创建一次<span class="token punctuation">)</span></span>
<span class="line">    	文本<span class="token punctuation">,</span> 图片<span class="token punctuation">,</span> 链接</span>
<span class="line"></span>
<span class="line">推荐</span>
<span class="line">	推荐<span class="token operator">/</span>取消推荐</span>
<span class="line">    我的推荐列表</span>
<span class="line">    </span>
<span class="line">收藏</span>
<span class="line">	收藏<span class="token operator">/</span>取消收藏</span>
<span class="line">    我的收藏列表</span>
<span class="line">    </span>
<span class="line">评论</span>
<span class="line">	创建评论</span>
<span class="line">    	<span class="token operator">-</span>判断是根评论还是子评论</span>
<span class="line">    	<span class="token operator">-</span>回复<span class="token punctuation">,</span>深度<span class="token operator">+</span><span class="token number">1</span></span>
<span class="line">        <span class="token operator">-</span>评论后<span class="token punctuation">,</span>更新根评论的<span class="token punctuation">(</span>后代更新时间<span class="token punctuation">)</span></span>
<span class="line">    展示评论列表</span>
<span class="line">    	<span class="token operator">-</span>根据<span class="token punctuation">(</span>后代更新时间<span class="token punctuation">)</span>从大到小进行排序<span class="token punctuation">,</span>读取根评论</span>
<span class="line">        <span class="token operator">-</span>读取根评论相关的子评论<span class="token punctuation">,</span> 将子评论挂靠到根评论上<span class="token punctuation">,</span>形成父子关系</span>
<span class="line">     <span class="token punctuation">[</span>	根评论<span class="token punctuation">:</span></span>
<span class="line">         <span class="token punctuation">{</span><span class="token builtin">id</span><span class="token punctuation">,</span> news<span class="token punctuation">,</span> content<span class="token punctuation">,</span> 子评论列表<span class="token punctuation">:</span> <span class="token punctuation">[</span></span>
<span class="line">             一级子评论<span class="token punctuation">:</span></span>
<span class="line">             <span class="token punctuation">{</span><span class="token builtin">id</span><span class="token punctuation">,</span> news<span class="token punctuation">,</span> content<span class="token punctuation">,</span> 子评论列表<span class="token punctuation">:</span><span class="token punctuation">[</span></span>
<span class="line">                 二级子评论<span class="token punctuation">:</span></span>
<span class="line">                 <span class="token punctuation">{</span><span class="token builtin">id</span><span class="token punctuation">,</span> news<span class="token punctuation">,</span> content<span class="token punctuation">,</span> 子评论列表<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">             <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">             <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">             </span>
<span class="line">         <span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token punctuation">{</span><span class="token builtin">id</span><span class="token punctuation">,</span> news<span class="token punctuation">,</span> content<span class="token punctuation">,</span> 子评论列表<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">         <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">     <span class="token punctuation">]</span> </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作"><span>准备工作</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token number">1.</span>创建一个django项目</span>
<span class="line"><span class="token number">2.</span>在项目settings<span class="token punctuation">.</span>py中的</span>
<span class="line">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">    <span class="token string">&#39;rest_framework&#39;</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="表结构" tabindex="-1"><a class="header-anchor" href="#表结构"><span>表结构</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db <span class="token keyword">import</span> models</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># Create your models here.</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Delete</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    deleted <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;已删除&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        abstract <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># 抽象类, 不会创建表(不能实例化), 只能用于给其他类继承</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">UserInfo</span><span class="token punctuation">(</span>Delete<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    username <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;用户名&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    password <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;密码&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    phone <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;手机号&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    token <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    token_expiry_date <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;token有效期&#39;</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    status_choices <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;禁用&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;激活&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    status <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>choices<span class="token operator">=</span>status_choices<span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;状态&#39;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Topic</span><span class="token punctuation">(</span>Delete<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;话题&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    is_hot <span class="token operator">=</span> models<span class="token punctuation">.</span>BooleanField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;热门话题&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;UserInfo&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;用户&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line">    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">News</span><span class="token punctuation">(</span>Delete<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    title <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">150</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;文字&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># xxx.jpg, yyy.jpg</span></span>
<span class="line">    image <span class="token operator">=</span> models<span class="token punctuation">.</span>TextField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;图片地址&#39;</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    url <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;链接&#39;</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    topic <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;Topic&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;话题&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;UserInfo&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;用户&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    status_choices <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;待审核&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">&#39;已通过&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">&#39;未通过&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    status <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>choices<span class="token operator">=</span>status_choices<span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;状态&#39;</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 数据库优化</span></span>
<span class="line">    collect_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;收藏数&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    recommend_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;推荐数&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    comment_count <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;评论数&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Collect</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;UserInfo&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;用户&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line">    news <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;News&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;资讯&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line">    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Recommend</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;UserInfo&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;用户&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line">    news <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;News&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;资讯&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line">    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Comment</span><span class="token punctuation">(</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    user <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;UserInfo&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;用户&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line">    news <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;News&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;资讯&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line">    content <span class="token operator">=</span> models<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>max_length<span class="token operator">=</span><span class="token number">150</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;评论内容&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    create_time <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;创建时间&#39;</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    root <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;Comment&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;根评论&#39;</span><span class="token punctuation">,</span> null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span></span>
<span class="line">                             related_name<span class="token operator">=</span><span class="token string">&#39;descendant&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">)</span></span>
<span class="line">    reply <span class="token operator">=</span> models<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span>to<span class="token operator">=</span><span class="token string">&#39;Comment&#39;</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;父评论&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                              related_name<span class="token operator">=</span><span class="token string">&#39;reply_list&#39;</span><span class="token punctuation">,</span> on_delete<span class="token operator">=</span>models<span class="token punctuation">.</span>CASCADE<span class="token punctuation">,</span></span>
<span class="line">                              null<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> blank<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    depth <span class="token operator">=</span> models<span class="token punctuation">.</span>IntegerField<span class="token punctuation">(</span>default<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> verbose_name<span class="token operator">=</span><span class="token string">&#39;深度&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 针对根评论设置后代更新时间</span></span>
<span class="line">    descendant_update_datetime <span class="token operator">=</span> models<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span>verbose_name<span class="token operator">=</span><span class="token string">&#39;后代更新时间&#39;</span><span class="token punctuation">,</span> auto_now_add<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了规范我们的项目,总路由不做路由和视图之间的对应关系,而是做路由分发.在应用文件夹中创建urls.py做路由和视图之间的对应关系</p><p>之后的视图都不放在一个py文件中,在应用文件夹中创建一个views文件夹,然后再在views文件夹中按照功能去写对应的py文件放对应功能的视图</p><p>以及之后一些配置内容也要创建相应的文件夹存放对应的功能.在应用文件夹中创建一个extension文件夹</p><p>所有的序列化类:在应用文件夹创建一个serializer文件夹,写入所有功能的序列化类</p><ul><li>extension文件夹</li></ul><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 创建extension文件夹写入全局先关的一些配置文件</span></span>
<span class="line"><span class="token comment"># 在extension文件夹中创建mixins.py文件,写入自定义的五大类(你们可以不写)</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> mixins</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension <span class="token keyword">import</span> return_code</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyCreateModelMixin</span><span class="token punctuation">(</span>mixins<span class="token punctuation">.</span>CreateModelMixin<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># self.get_serializer:获取视图类变量中的序列化类</span></span>
<span class="line">        ser <span class="token operator">=</span> self<span class="token punctuation">.</span>get_serializer<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> ser<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>VALIDATE_ERROR<span class="token punctuation">,</span> <span class="token string">&#39;detail&#39;</span><span class="token punctuation">:</span> ser<span class="token punctuation">.</span>errors<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        ret <span class="token operator">=</span> self<span class="token punctuation">.</span>perform_create<span class="token punctuation">(</span>ser<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> ret <span class="token keyword">or</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> ser<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    </span>
<span class="line"> </span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyListModelMixin</span><span class="token punctuation">(</span>mixins<span class="token punctuation">.</span>ListModelMixin<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># self.get_queryset():获取类变量中的queryset对象</span></span>
<span class="line">        <span class="token comment"># filter_queryset:调用过滤器中的该方法对queryset对象再次进行过滤</span></span>
<span class="line">        queryset <span class="token operator">=</span> self<span class="token punctuation">.</span>filter_queryset<span class="token punctuation">(</span>self<span class="token punctuation">.</span>get_queryset<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># paginate_queryset:对queryset对象进行分页处理</span></span>
<span class="line">        page <span class="token operator">=</span> self<span class="token punctuation">.</span>paginate_queryset<span class="token punctuation">(</span>queryset<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> page <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            serializer <span class="token operator">=</span> self<span class="token punctuation">.</span>get_serializer<span class="token punctuation">(</span>page<span class="token punctuation">,</span> many<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>get_paginated_response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> serializer<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        serializer <span class="token operator">=</span> self<span class="token punctuation">.</span>get_serializer<span class="token punctuation">(</span>queryset<span class="token punctuation">,</span> many<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> serializer<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>return_code.py</li></ul><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 后续所以返回的响应码我们都提前定义好,后续调用即可</span></span>
<span class="line"><span class="token comment"># 在extension文件夹中创建return_code.py写入</span></span>
<span class="line"><span class="token comment"># 成功</span></span>
<span class="line">SUCCESS <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 用户提交数据校验失败</span></span>
<span class="line">VALIDATE_ERROR <span class="token operator">=</span> <span class="token number">1001</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 认证失败</span></span>
<span class="line">AUTH_FAILED <span class="token operator">=</span> <span class="token number">2000</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 认证过期</span></span>
<span class="line">AUTH_OVERDUE <span class="token operator">=</span> <span class="token number">2001</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 无权访问</span></span>
<span class="line">PERMISSION_DENIED <span class="token operator">=</span> <span class="token number">3000</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 限流</span></span>
<span class="line">TOO_MANY_REQUESTS <span class="token operator">=</span> <span class="token number">4000</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="注册功能" tabindex="-1"><a class="header-anchor" href="#注册功能"><span>注册功能</span></a></h2><h3 id="路由" tabindex="-1"><a class="header-anchor" href="#路由"><span>路由</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 总路由做路由分发:项目同名文件夹中的urls.py</span></span>
<span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>contrib <span class="token keyword">import</span> admin</span>
<span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include</span>
<span class="line"><span class="token comment"># 路由分发</span></span>
<span class="line">urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">    path<span class="token punctuation">(</span><span class="token string">&#39;admin/&#39;</span><span class="token punctuation">,</span> admin<span class="token punctuation">.</span>site<span class="token punctuation">.</span>urls<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    path<span class="token punctuation">(</span><span class="token string">&#39;api/&#39;</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token string">&#39;api.urls&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 应用文件夹中创建一个urls.py做路由和视图之间的对应关系</span></span>
<span class="line"><span class="token comment"># api文件夹中的urls.py</span></span>
<span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path</span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> routers</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>views <span class="token keyword">import</span> account</span>
<span class="line"></span>
<span class="line">router <span class="token operator">=</span> routers<span class="token punctuation">.</span>SimpleRouter<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">router<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">r&#39;register&#39;</span><span class="token punctuation">,</span> account<span class="token punctuation">.</span>RegisterView<span class="token punctuation">,</span> <span class="token string">&#39;register&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line"></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">urlpatterns <span class="token operator">+=</span> router<span class="token punctuation">.</span>urls</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="序列化类" tabindex="-1"><a class="header-anchor" href="#序列化类"><span>序列化类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在应用文件夹api文件夹中创建serializer文件夹, 在再该文件夹中创建account.py写入注册相关的序列化类</span></span>
<span class="line"><span class="token comment"># api.serializer.account.py</span></span>
<span class="line"><span class="token comment"># 用户相关的序列化类</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> serializers</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ValidationError</span>
<span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>validators <span class="token keyword">import</span> RegexValidator</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RegisterSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    confirm_password <span class="token operator">=</span> serializers<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&#39;确认密码&#39;</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> write_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    password <span class="token operator">=</span> serializers<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&#39;密码&#39;</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">,</span> max_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> write_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    phone <span class="token operator">=</span> serializers<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&#39;手机号&#39;</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>RegexValidator<span class="token punctuation">(</span><span class="token string">&#39;1[3-9]\d{9}&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;请输入正确格式的手机号&#39;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;username&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;password&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;phone&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;confirm_password&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        extra_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;username&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;error_messages&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;required&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;用户名不能为空&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;max_length&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;用户名最长32位&#39;</span><span class="token punctuation">}</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 钩子函数:判断用户名是否存在</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">validate_username</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        exist <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>username<span class="token operator">=</span>attrs<span class="token punctuation">,</span> deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> exist<span class="token punctuation">:</span>  <span class="token comment"># 用户名存在</span></span>
<span class="line">            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;用户名已存在&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> attrs</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 钩子函数:判断手机号是否存在</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">validate_phone</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        exist <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>phone<span class="token operator">=</span>attrs<span class="token punctuation">,</span> deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> exist<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;手机号已存在&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> attrs</span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 钩子函数:判断两次密码是否一致</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">validate_confirm_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 手动钩password字段值</span></span>
<span class="line">        password <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;password&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> password <span class="token operator">!=</span> attrs<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;两次密码不一致&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> attrs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="视图类" tabindex="-1"><a class="header-anchor" href="#视图类"><span>视图类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在应用文件夹中创建views文件夹,再在views文件夹中创建account.py写入用户相关的视图</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> MyCreateModelMixin</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>account <span class="token keyword">import</span> RegisterSerializer</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RegisterView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 因为后续会在全局设置认证和权限类,所以不需要认证和权限</span></span>
<span class="line">    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    permission_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> RegisterSerializer</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>validated_data<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token string">&#39;confirm_password&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line"><span class="token comment"># 访问:</span></span>
<span class="line">post请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>register<span class="token operator">/</span></span>
<span class="line">   请求体<span class="token punctuation">:</span>form<span class="token operator">-</span>data<span class="token punctuation">:</span></span>
<span class="line">        username<span class="token punctuation">,</span> phone<span class="token punctuation">,</span> password<span class="token punctuation">,</span> confirm_pasword</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="登录功能" tabindex="-1"><a class="header-anchor" href="#登录功能"><span>登录功能</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 输入用户名+密码或者手机号+密码, 不能用户名+手机号+密码</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><h3 id="路由-1" tabindex="-1"><a class="header-anchor" href="#路由-1"><span>路由</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在应用文件夹api下的urls.py中写入</span></span>
<span class="line">urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span></span>
<span class="line">	path<span class="token punctuation">(</span><span class="token string">&#39;auth/&#39;</span><span class="token punctuation">,</span> account<span class="token punctuation">.</span>AuthView<span class="token punctuation">.</span>as_view<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">&#39;auth&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="序列化类-1" tabindex="-1"><a class="header-anchor" href="#序列化类-1"><span>序列化类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹的serializer文件夹中的account.py中写入</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">AuthSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>Serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    username <span class="token operator">=</span> serializers<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&#39;用户名&#39;</span><span class="token punctuation">,</span> write_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line">    phone <span class="token operator">=</span> serializers<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&#39;手机号&#39;</span><span class="token punctuation">,</span> write_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line">    password <span class="token operator">=</span> serializers<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">&#39;密码&#39;</span><span class="token punctuation">,</span> write_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> min_length<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">validate_username</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        username <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;username&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        phone <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;phone&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> username <span class="token keyword">and</span> <span class="token keyword">not</span> phone<span class="token punctuation">:</span>  <span class="token comment"># 不能同时不输入手机和用户名</span></span>
<span class="line">            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;用户名或手机号为空&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> username <span class="token keyword">and</span> phone<span class="token punctuation">:</span>  <span class="token comment"># 不能同时输入用户名和手机</span></span>
<span class="line">            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;数据提交异常&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> attrs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="视图类-1" tabindex="-1"><a class="header-anchor" href="#视图类-1"><span>视图类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹中的views文件夹中的account.py写入</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>account <span class="token keyword">import</span> RegisterSerializer<span class="token punctuation">,</span> AuthSerializer</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>views <span class="token keyword">import</span> APIView</span>
<span class="line"><span class="token keyword">import</span> uuid</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension <span class="token keyword">import</span> return_code</span>
<span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>db<span class="token punctuation">.</span>models <span class="token keyword">import</span> Q</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">import</span> datetime</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">AuthView</span><span class="token punctuation">(</span>APIView<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">    permission_classes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">post</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 获取数据判断是否符合校验规则</span></span>
<span class="line">        ser <span class="token operator">=</span> AuthSerializer<span class="token punctuation">(</span>data<span class="token operator">=</span>request<span class="token punctuation">.</span>data<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> ser<span class="token punctuation">.</span>is_valid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>VALIDATE_ERROR<span class="token punctuation">,</span> <span class="token string">&#39;detail&#39;</span><span class="token punctuation">:</span> ser<span class="token punctuation">.</span>errors<span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        username <span class="token operator">=</span> ser<span class="token punctuation">.</span>validated_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;username&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        phone <span class="token operator">=</span> ser<span class="token punctuation">.</span>validated_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;phone&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        password <span class="token operator">=</span> ser<span class="token punctuation">.</span>validated_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;password&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> username <span class="token keyword">and</span> <span class="token keyword">not</span> phone<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>VALIDATE_ERROR<span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;用户名和密码不能同时为空&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 用户名+密码, 或者手机号+密码</span></span>
<span class="line">        user_obj <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>Q<span class="token punctuation">(</span>Q<span class="token punctuation">(</span>username<span class="token operator">=</span>username<span class="token punctuation">)</span> <span class="token operator">|</span> Q<span class="token punctuation">(</span>phone<span class="token operator">=</span>phone<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                                                  password<span class="token operator">=</span>password<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> user_obj<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>VALIDATE_ERROR<span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;用户不存在&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        token <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        user_obj<span class="token punctuation">.</span>token <span class="token operator">=</span> token</span>
<span class="line">        <span class="token comment"># 设置token有效期,当前时间+2周</span></span>
<span class="line">        user_obj<span class="token punctuation">.</span>token_expiry_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> datetime<span class="token punctuation">.</span>timedelta<span class="token punctuation">(</span>weeks<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line">        user_obj<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span></span>
<span class="line">                         <span class="token string">&#39;date&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">:</span> token<span class="token punctuation">,</span> <span class="token string">&#39;name&#39;</span><span class="token punctuation">:</span> user_obj<span class="token punctuation">.</span>username<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    </span>
<span class="line">    </span>
<span class="line">    </span>
<span class="line"><span class="token comment"># 访问:</span></span>
<span class="line">post请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>auth<span class="token operator">/</span></span>
<span class="line"> 请求体<span class="token punctuation">:</span>form<span class="token operator">-</span>data</span>
<span class="line">    用户名<span class="token operator">+</span>密码</span>
<span class="line">    手机号<span class="token operator">+</span>密码</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="时区设置" tabindex="-1"><a class="header-anchor" href="#时区设置"><span>时区设置</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在settings.py中设置</span></span>
<span class="line">LANGUAGE_CODE <span class="token operator">=</span> <span class="token string">&#39;zh-hans&#39;</span></span>
<span class="line"></span>
<span class="line">TIME_ZONE <span class="token operator">=</span> <span class="token string">&#39;Asia/Shanghai&#39;</span></span>
<span class="line"></span>
<span class="line">USE_I18N <span class="token operator">=</span> <span class="token boolean">True</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># USE_TZ = True  # 创建时用UTC时间</span></span>
<span class="line">USE_TZ <span class="token operator">=</span> <span class="token boolean">False</span>  <span class="token comment"># 创建时根据TIME_ZONE设置的时区进行写入</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="登录认证" tabindex="-1"><a class="header-anchor" href="#登录认证"><span>登录认证</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在extension文件夹中创建auth.py写入登录认证</span></span>
<span class="line"><span class="token comment"># 登录认证</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>authentication <span class="token keyword">import</span> BaseAuthentication</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> AuthenticationFailed</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension <span class="token keyword">import</span> return_code</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">import</span> datetime</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 必须登录登录才能访问</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TokenAuthentication</span><span class="token punctuation">(</span>BaseAuthentication<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        token <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 1.判断是否获取到token</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> token<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> AuthenticationFailed<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>AUTH_FAILED<span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;认证失败&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 2.判断token有没有对应的用户</span></span>
<span class="line">        user_obj <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>token<span class="token operator">=</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> user_obj<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> AuthenticationFailed<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>AUTH_FAILED<span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;认证失败&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 3.判断token是否过期:当前时间&gt;有效期--&gt;过期</span></span>
<span class="line">        <span class="token keyword">if</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now <span class="token operator">&gt;</span> user_obj<span class="token punctuation">.</span>token_expiry_date<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> AuthenticationFailed<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>AUTH_FAILED<span class="token punctuation">,</span> <span class="token string">&#39;error&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;认证失败&#39;</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> user_obj<span class="token punctuation">,</span> token</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate_header</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&#39;Bearer realm=&quot;API&quot;&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 不登录也可以访问</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NoTokenAuthentication</span><span class="token punctuation">(</span>BaseAuthentication<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        token <span class="token operator">=</span> request<span class="token punctuation">.</span>query_params<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;token&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 1.判断是否获取到token</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> token<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line">        <span class="token comment"># 2.判断token有没有对应的用户</span></span>
<span class="line">        user_obj <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>token<span class="token operator">=</span>token<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> user_obj<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line">        <span class="token comment"># 3.判断token是否过期:当前时间&gt;有效期--&gt;过期</span></span>
<span class="line">        <span class="token keyword">if</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> user_obj<span class="token punctuation">.</span>token_expiry_date<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">None</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> user_obj<span class="token punctuation">,</span> token</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">authenticate_header</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token string">&#39;Bearer realm=&quot;API&quot;&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 进行全局配置,默认必须登录才能访问视图</span></span>
<span class="line"><span class="token comment"># settings.py</span></span>
<span class="line">REST_FRAMEWORK <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment"># 认证配置</span></span>
<span class="line">    <span class="token string">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&#39;api.extension.auth.TokenAuthentication&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&#39;UNAUTHENTICATED_USER&#39;</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token boolean">None</span><span class="token punctuation">,</span>  <span class="token comment"># 没有登录时request.user获取为None</span></span>
<span class="line">    <span class="token string">&#39;UNAUTHENTICATED_TOKEN&#39;</span><span class="token punctuation">:</span> <span class="token keyword">lambda</span><span class="token punctuation">:</span> <span class="token boolean">None</span>  <span class="token comment"># # 没有登录时request.auth获取为None</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="话题" tabindex="-1"><a class="header-anchor" href="#话题"><span>话题</span></a></h2><h3 id="创建话题" tabindex="-1"><a class="header-anchor" href="#创建话题"><span>创建话题</span></a></h3><h4 id="路由-2" tabindex="-1"><a class="header-anchor" href="#路由-2"><span>路由</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹中的urls.py写入</span></span>
<span class="line"><span class="token comment"># 在api.views文件夹中创建topic.py</span></span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>views <span class="token keyword">import</span> account<span class="token punctuation">,</span> topic</span>
<span class="line"></span>
<span class="line">router<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">r&#39;topic&#39;</span><span class="token punctuation">,</span> topic<span class="token punctuation">.</span>TopicView<span class="token punctuation">,</span> <span class="token string">&#39;topic&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="序列化" tabindex="-1"><a class="header-anchor" href="#序列化"><span>序列化</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹的serializer文件夹创建topic.py写入话题相关的序列化类</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> serializers</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TopicSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Topic</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;title&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;is_hot&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        extra_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;is_hot&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;read_only&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="视图类-2" tabindex="-1"><a class="header-anchor" href="#视图类-2"><span>视图类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.views文件夹中创建topic.py写入</span></span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> MyCreateModelMixin</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>topic <span class="token keyword">import</span> TopicSerializer</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TopicView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> TopicSerializer</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">     </span>
<span class="line"><span class="token comment"># 访问:</span></span>
<span class="line">post请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>topic<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971</span>
<span class="line">  请求体<span class="token punctuation">:</span>form<span class="token operator">-</span>data</span>
<span class="line">    <span class="token builtin">id</span><span class="token punctuation">,</span> title       </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="展示话题" tabindex="-1"><a class="header-anchor" href="#展示话题"><span>展示话题</span></a></h3><h4 id="过滤器" tabindex="-1"><a class="header-anchor" href="#过滤器"><span>过滤器</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹中的extension文件夹中创建filter.py写入自定义的过滤器,用来过滤当前登录的用户的数据</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>filters <span class="token keyword">import</span> BaseFilterBackend</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">SelfFilter</span><span class="token punctuation">(</span>BaseFilterBackend<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">filter_queryset</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> queryset<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> queryset<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="分页器" tabindex="-1"><a class="header-anchor" href="#分页器"><span>分页器</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 分页不再像之前一样每页限制多少条数据,或者从第几条开始访问</span></span>
<span class="line"><span class="token comment"># 在api文件夹的extension文件夹中创建page.py写入自定义的分页器</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>pagination <span class="token keyword">import</span> LimitOffsetPagination</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyPagination</span><span class="token punctuation">(</span>LimitOffsetPagination<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    default_limit <span class="token operator">=</span> <span class="token number">10</span></span>
<span class="line">    max_limit <span class="token operator">=</span> <span class="token number">100</span></span>
<span class="line">    offset_query_param <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># 不用这个参数进行分页</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="视图" tabindex="-1"><a class="header-anchor" href="#视图"><span>视图</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹的views文件夹中的topic.py文件中写入</span></span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>topic <span class="token keyword">import</span> TopicSerializer</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token keyword">import</span> SelfFilter</span>
<span class="line"><span class="token keyword">from</span> django_filters<span class="token punctuation">.</span>rest_framework <span class="token keyword">import</span> DjangoFilterBackend</span>
<span class="line"><span class="token keyword">from</span> django_filters <span class="token keyword">import</span> FilterSet<span class="token punctuation">,</span> filters</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 通过第三方过滤器限制上次访问的数据位置</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TopicFilter</span><span class="token punctuation">(</span>FilterSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    latest_id <span class="token operator">=</span> filters<span class="token punctuation">.</span>NumberFilter<span class="token punctuation">(</span>field_name<span class="token operator">=</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> lookup_expr<span class="token operator">=</span><span class="token string">&#39;lt&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Topic</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;latest_id&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TopicView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> TopicSerializer</span>
<span class="line">    queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>Topic<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&#39;-id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>SelfFilter<span class="token punctuation">,</span> DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> TopicFilter</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line"><span class="token comment"># 访问:</span></span>
<span class="line">post请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>topic<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971 <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>获取当前登录用户所有的话题</span>
<span class="line">	限制每次访问<span class="token number">2</span>条数据<span class="token punctuation">:</span></span>
<span class="line">        http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>topic<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971<span class="token operator">&amp;</span>limit<span class="token operator">=</span><span class="token number">2</span></span>
<span class="line">    上次访问的位置是<span class="token builtin">id</span>为<span class="token number">3</span>的数据<span class="token punctuation">:</span></span>
<span class="line">        http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>topic<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971<span class="token operator">&amp;</span>limit<span class="token operator">=</span><span class="token number">2</span><span class="token operator">&amp;</span>latest_id<span class="token operator">=</span><span class="token number">3</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="更新话题" tabindex="-1"><a class="header-anchor" href="#更新话题"><span>更新话题</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在话题的视图类中加上UpdateModelMixin的继承</span></span>
<span class="line"><span class="token comment"># api文件夹中的views文件夹中的topic.py</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> UpdateModelMixin</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TopicView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin<span class="token punctuation">,</span> UpdateModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> TopicSerializer</span>
<span class="line">    queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>Topic<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&#39;-id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>SelfFilter<span class="token punctuation">,</span> DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> TopicFilter</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        </span>
<span class="line"><span class="token comment"># 访问</span></span>
<span class="line">put请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>topic<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971</span>
<span class="line">  请求体<span class="token punctuation">:</span>form<span class="token operator">-</span>data</span>
<span class="line">    title</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="删除话题" tabindex="-1"><a class="header-anchor" href="#删除话题"><span>删除话题</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在话题的视图类中加上DestoryModelMixin的继承,重写perform_destroy方法,不删除数据,而是修改数据的deleted属性</span></span>
<span class="line"><span class="token comment"># api文件夹中的views文件夹中的topic.py</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> UpdateModelMixin<span class="token punctuation">,</span> DestroyModelMixin</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">TopicView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin<span class="token punctuation">,</span> UpdateModelMixin<span class="token punctuation">,</span> DestroyModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> TopicSerializer</span>
<span class="line">    queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>Topic<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&#39;-id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>SelfFilter<span class="token punctuation">,</span> DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> TopicFilter</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_destroy</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        instance<span class="token punctuation">.</span>deleted <span class="token operator">=</span> <span class="token boolean">True</span></span>
<span class="line">        instance<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 访问:</span></span>
<span class="line">delete请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>topic<span class="token operator">/</span><span class="token number">1</span><span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="资讯" tabindex="-1"><a class="header-anchor" href="#资讯"><span>资讯</span></a></h2><h3 id="创建资讯" tabindex="-1"><a class="header-anchor" href="#创建资讯"><span>创建资讯</span></a></h3><h4 id="路由-3" tabindex="-1"><a class="header-anchor" href="#路由-3"><span>路由</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹中的urls.py写入</span></span>
<span class="line"><span class="token comment"># 同时在api文件夹的views文件夹创建news.py写入资讯相关的视图</span></span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>views <span class="token keyword">import</span> account<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> news</span>
<span class="line">router<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">r&#39;news&#39;</span><span class="token punctuation">,</span> news<span class="token punctuation">.</span>NewsView<span class="token punctuation">,</span> <span class="token string">&#39;news&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="序列化类-2" tabindex="-1"><a class="header-anchor" href="#序列化类-2"><span>序列化类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹中的serializer文件夹中创建news.py写入资讯相关的序列化类</span></span>
<span class="line"><span class="token comment"># api.serializer.news.py</span></span>
<span class="line"><span class="token comment"># 资讯相关的序列化类</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> serializers</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ValidationError</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 序列化是获取图片地址进行切分放到列表中返回</span></span>
<span class="line">    image_list <span class="token operator">=</span> serializers<span class="token punctuation">.</span>SerializerMethodField<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 序列化是获取关联的话题的名字</span></span>
<span class="line">    topic_title <span class="token operator">=</span> serializers<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>source<span class="token operator">=</span><span class="token string">&#39;topic.title&#39;</span><span class="token punctuation">,</span> read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 序列化时获取资讯状态实际的值</span></span>
<span class="line">    status <span class="token operator">=</span> serializers<span class="token punctuation">.</span>CharField<span class="token punctuation">(</span>source<span class="token operator">=</span><span class="token string">&#39;get_status_display&#39;</span><span class="token punctuation">,</span> read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>News</span>
<span class="line">        <span class="token triple-quoted-string string">&#39;&#39;&#39;</span>
<span class="line">            &#39;id&#39;, &#39;title&#39;, &#39;url&#39;:既数据校验又序列化</span>
<span class="line">            &#39;image&#39;, &#39;topic&#39;:数据校验</span>
<span class="line">            &#39;image_list&#39;, &#39;topic_title&#39;:序列化</span>
<span class="line">            &#39;collect_count&#39;, &#39;recommend_count&#39;, &#39;comment_count&#39;:序列化</span>
<span class="line">            &#39;status&#39;:序列化</span>
<span class="line">        &#39;&#39;&#39;</span></span>
<span class="line"></span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;title&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                  <span class="token string">&#39;image&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;topic&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                  <span class="token string">&#39;image_list&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;topic_title&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                  <span class="token string">&#39;collect_count&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;recommend_count&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;comment_count&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                  <span class="token string">&#39;status&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        extra_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;image&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;write_only&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;topic&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;write_only&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        read_only_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;collect_count&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;recommend_count&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;comment_count&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_image_list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># obj:当前的资讯对象</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> obj<span class="token punctuation">.</span>image<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">return</span> obj<span class="token punctuation">.</span>image<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 判断传入的topic的id是否有对应的话题</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">validate_topic</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># attrs:就是要校验的话题对象</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> attrs<span class="token punctuation">:</span>  <span class="token comment"># 如果没有数据不需要校验</span></span>
<span class="line">            <span class="token keyword">return</span> attrs</span>
<span class="line">        <span class="token comment"># 序列化类中不能直接通过self获取到request对象</span></span>
<span class="line">        <span class="token comment"># 保存在了self.context中</span></span>
<span class="line">        request <span class="token operator">=</span> self<span class="token punctuation">.</span>context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        exists <span class="token operator">=</span> models<span class="token punctuation">.</span>Topic<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token operator">=</span>attrs<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> user<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> exists<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;话题不存在&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> attrs</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">validate_title</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 不能同时传入链接和图片</span></span>
<span class="line">        url <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;url&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        image <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;image&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> url <span class="token keyword">and</span> image<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;请求数据错误&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> attrs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="视图类-3" tabindex="-1"><a class="header-anchor" href="#视图类-3"><span>视图类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api文件夹中的views文件夹中的news.py</span></span>
<span class="line"><span class="token comment"># 写入资讯相关的视图</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> CreateModelMixin</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>news <span class="token keyword">import</span> NewsSerializer</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsView</span><span class="token punctuation">(</span>CreateModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> NewsSerializer</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line"><span class="token comment"># 访问</span></span>
<span class="line">post请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>news<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971</span>
<span class="line">  请求体<span class="token punctuation">:</span>raw</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;title&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;这是第一条资讯&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;image&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;xxx.jpg,yyy.jpg&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;topic&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">  或者</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token string">&quot;id&quot;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;title&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;这是第一条资讯&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;url&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;wwwww.com&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token string">&quot;topic&quot;</span><span class="token punctuation">:</span> <span class="token number">2</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="展示我的资讯" tabindex="-1"><a class="header-anchor" href="#展示我的资讯"><span>展示我的资讯</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api文件夹中的views文件夹的news.py</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> CreateModelMixin<span class="token punctuation">,</span> ListModelMixin</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>news <span class="token keyword">import</span> NewsSerializer</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token keyword">import</span> SelfFilter</span>
<span class="line"><span class="token keyword">from</span> django_filters<span class="token punctuation">.</span>rest_framework <span class="token keyword">import</span> DjangoFilterBackend</span>
<span class="line"><span class="token keyword">from</span> django_filters <span class="token keyword">import</span> FilterSet<span class="token punctuation">,</span> filters</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsFilter</span><span class="token punctuation">(</span>FilterSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    latest_id <span class="token operator">=</span> filters<span class="token punctuation">.</span>NumberFilter<span class="token punctuation">(</span>field_name<span class="token operator">=</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> lookup_expr<span class="token operator">=</span><span class="token string">&#39;lt&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>News</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;latest_id&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsView</span><span class="token punctuation">(</span>CreateModelMixin<span class="token punctuation">,</span> ListModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> NewsSerializer</span>
<span class="line">    queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>News<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&#39;-id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>SelfFilter<span class="token punctuation">,</span> DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> NewsFilter</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line"><span class="token comment"># 访问</span></span>
<span class="line">get请求<span class="token punctuation">:</span></span>
<span class="line">    获取当前登录用户的所有资讯</span>
<span class="line">    http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>news<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971</span>
<span class="line">    限制获取两条数据</span>
<span class="line">    http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>news<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971<span class="token operator">&amp;</span>limit<span class="token operator">=</span><span class="token number">2</span></span>
<span class="line">    限制从<span class="token builtin">id</span>为<span class="token number">4</span>的数据往后访问<span class="token number">2</span>条数据</span>
<span class="line">   	http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>news<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971<span class="token operator">&amp;</span>limit<span class="token operator">=</span><span class="token number">2</span><span class="token operator">&amp;</span>latest_id<span class="token operator">=</span><span class="token number">4</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="限流" tabindex="-1"><a class="header-anchor" href="#限流"><span>限流</span></a></h3><h4 id="settings-py中定义缓存" tabindex="-1"><a class="header-anchor" href="#settings-py中定义缓存"><span>settings.py中定义缓存</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">CACHES <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token string">&quot;default&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token string">&quot;BACKEND&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;django_redis.cache.RedisCache&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;LOCATION&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;redis://127.0.0.1:6379&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token string">&quot;OPTIONS&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&quot;CLIENT_CLASS&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;django_redis.client.DefaultClient&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="限流类" tabindex="-1"><a class="header-anchor" href="#限流类"><span>限流类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 限制5分钟创建一次:之前的限流写法都是一分钟多少次</span></span>
<span class="line"><span class="token comment"># 限制失败的访问不算成功访问:之前的写法是不管成功注册还是失败注册都会不能访问第二次</span></span>
<span class="line"><span class="token comment"># 在api文件夹中的extension文件夹创建throttle.py写入限流类</span></span>
<span class="line"><span class="token comment"># 写入限流相关</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>throttling <span class="token keyword">import</span> SimpleRateThrottle</span>
<span class="line"><span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>cache <span class="token keyword">import</span> cache <span class="token keyword">as</span> default_cache</span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> exceptions</span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> status</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension <span class="token keyword">import</span> return_code</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ThrottleException</span><span class="token punctuation">(</span>exceptions<span class="token punctuation">.</span>APIException<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    status_code <span class="token operator">=</span> status<span class="token punctuation">.</span>HTTP_429_TOO_MANY_REQUESTS</span>
<span class="line">    default_code <span class="token operator">=</span> <span class="token string">&#39;throttled&#39;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">MyThrottle</span><span class="token punctuation">(</span>SimpleRateThrottle<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    cache <span class="token operator">=</span> default_cache</span>
<span class="line">    scope <span class="token operator">=</span> <span class="token string">&#39;user&#39;</span></span>
<span class="line">    cache_format <span class="token operator">=</span> <span class="token string">&#39;throttle_%s_%s&#39;</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 设置访问频率</span></span>
<span class="line">    THROTTLE_RATES <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;user&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;1/5m&#39;</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 重写父类的parse_rate,将原本的一分钟几次改为5分钟一次</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">parse_rate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rate<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> rate <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span></span>
<span class="line">        num<span class="token punctuation">,</span> period <span class="token operator">=</span> rate<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">)</span>  <span class="token comment"># num=&#39;1&#39;, period=&#39;5m&#39;</span></span>
<span class="line">        num_requests <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span></span>
<span class="line">        duration <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;s&#39;</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&#39;m&#39;</span><span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">&#39;h&#39;</span><span class="token punctuation">:</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string">&#39;d&#39;</span><span class="token punctuation">:</span> <span class="token number">86400</span><span class="token punctuation">}</span><span class="token punctuation">[</span>period<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span></span>
<span class="line">        count <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>period<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">(</span>num_requests<span class="token punctuation">,</span> duration <span class="token operator">*</span> count<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_cache_key</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">,</span> view<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        ident <span class="token operator">=</span> request<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token builtin">id</span></span>
<span class="line">        <span class="token keyword">return</span> self<span class="token punctuation">.</span>cache_format <span class="token operator">%</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>scope<span class="token punctuation">,</span> ident<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">throttle_failure</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        wait <span class="token operator">=</span> self<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        detail <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>TOO_MANY_REQUESTS<span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;访问频率限制&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token string">&#39;detail&#39;</span><span class="token punctuation">:</span> <span class="token string">&#39;还需要等待%s秒&#39;</span> <span class="token operator">%</span> wait</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">raise</span> ThrottleException<span class="token punctuation">(</span>detail<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 重写访问之后的方法:失败不算成功的一次访问,不加入缓存</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">throttle_success</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">True</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 自定义一个方法来创建缓存</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">done</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 创建成功资讯之后调用该方法</span></span>
<span class="line">        self<span class="token punctuation">.</span>history<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>now<span class="token punctuation">)</span></span>
<span class="line">        self<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>key<span class="token punctuation">,</span> self<span class="token punctuation">.</span>history<span class="token punctuation">,</span> self<span class="token punctuation">.</span>duration<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="在视图中使用限流类" tabindex="-1"><a class="header-anchor" href="#在视图中使用限流类"><span>在视图中使用限流类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api文件夹中的views文件夹的news.py</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> CreateModelMixin<span class="token punctuation">,</span> ListModelMixin</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>news <span class="token keyword">import</span> NewsSerializer</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token keyword">import</span> SelfFilter</span>
<span class="line"><span class="token keyword">from</span> django_filters<span class="token punctuation">.</span>rest_framework <span class="token keyword">import</span> DjangoFilterBackend</span>
<span class="line"><span class="token keyword">from</span> django_filters <span class="token keyword">import</span> FilterSet<span class="token punctuation">,</span> filters</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension <span class="token keyword">import</span> throttle</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsFilter</span><span class="token punctuation">(</span>FilterSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    latest_id <span class="token operator">=</span> filters<span class="token punctuation">.</span>NumberFilter<span class="token punctuation">(</span>field_name<span class="token operator">=</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> lookup_expr<span class="token operator">=</span><span class="token string">&#39;lt&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>News</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;latest_id&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">NewsView</span><span class="token punctuation">(</span>CreateModelMixin<span class="token punctuation">,</span> ListModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> NewsSerializer</span>
<span class="line">    queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>News<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&#39;-id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>SelfFilter<span class="token punctuation">,</span> DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> NewsFilter</span>
<span class="line">    <span class="token comment"># 自定义类变量保存限流对象</span></span>
<span class="line">    throttle_objects <span class="token operator">=</span> <span class="token punctuation">[</span>throttle<span class="token punctuation">.</span>MyThrottle<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 再限流:通过限流对象调用done方法计入缓存</span></span>
<span class="line">        <span class="token keyword">for</span> throttle <span class="token keyword">in</span> self<span class="token punctuation">.</span>get_throttles<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            throttle<span class="token punctuation">.</span>done<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 重写get_throttles方法获取限流对象</span></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_throttles</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> self<span class="token punctuation">.</span>throttle_objects  <span class="token comment"># 就是我们自定义的类变量</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="首页" tabindex="-1"><a class="header-anchor" href="#首页"><span>首页</span></a></h2><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 也是对资讯的获取,获取所有status通过审核,且没被删除的所有资讯</span></span>
<span class="line"><span class="token comment"># 首页的所有所有资讯里,如果登录的用户收藏了或者推荐了应该要显示出来.没有登录就不要显示这些信息(首页用户登录或者不登录都能访问)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="路由-4" tabindex="-1"><a class="header-anchor" href="#路由-4"><span>路由</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api文件夹的urls.py</span></span>
<span class="line">router<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&#39;index&#39;</span><span class="token punctuation">,</span> news<span class="token punctuation">.</span>IndexView<span class="token punctuation">,</span> <span class="token string">&#39;index&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="序列化类-3" tabindex="-1"><a class="header-anchor" href="#序列化类-3"><span>序列化类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api文件的serializer文件夹中的news.py</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 首页的序列化类:只做序列化不做数据校验</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">IndexTopicSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Topic</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;title&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;is_hot&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">IndexUserSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>UserInfo</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;username&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">IndexSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 获取图片列表</span></span>
<span class="line">    image_list <span class="token operator">=</span> serializers<span class="token punctuation">.</span>SerializerMethodField<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 获取收藏数以及判断用户是否登录(登录的话用户是否收藏过当前资讯)</span></span>
<span class="line">    collect <span class="token operator">=</span> serializers<span class="token punctuation">.</span>SerializerMethodField<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 获取推荐数以及判断用户是否登录(登录的话用户是否推荐过当前资讯)</span></span>
<span class="line">    recommend <span class="token operator">=</span> serializers<span class="token punctuation">.</span>SerializerMethodField<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    topic <span class="token operator">=</span> IndexTopicSerializer<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    user <span class="token operator">=</span> IndexUserSerializer<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>News</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;title&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;image_list&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;topic&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;user&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                  <span class="token string">&#39;collect&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;recommend&#39;</span><span class="token punctuation">,</span></span>
<span class="line">                  <span class="token string">&#39;comment_count&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_image_list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> obj<span class="token punctuation">.</span>image<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">return</span> obj<span class="token punctuation">.</span>image<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_collect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># obj:获取到当前序列化类基于的模型类的对象</span></span>
<span class="line">        request <span class="token operator">=</span> self<span class="token punctuation">.</span>context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">:</span>  <span class="token comment"># 用户未登录</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;count&#39;</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>collect_count<span class="token punctuation">,</span> <span class="token string">&#39;has_collect&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment"># 用户登录:判断用户是否收藏过</span></span>
<span class="line">        exists <span class="token operator">=</span> models<span class="token punctuation">.</span>Collect<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> news<span class="token operator">=</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;count&#39;</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>collect_count<span class="token punctuation">,</span> <span class="token string">&#39;has_collect&#39;</span><span class="token punctuation">:</span> exists<span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_recommend</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        request <span class="token operator">=</span> self<span class="token punctuation">.</span>context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;request&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> request<span class="token punctuation">.</span>user<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;count&#39;</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>recommend_count<span class="token punctuation">,</span> <span class="token string">&#39;has_recommend&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span></span>
<span class="line">        exists <span class="token operator">=</span> models<span class="token punctuation">.</span>Recommend<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> news<span class="token operator">=</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token string">&#39;count&#39;</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>recommend_count<span class="token punctuation">,</span> <span class="token string">&#39;has_recommend&#39;</span><span class="token punctuation">:</span> exists<span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="视图-1" tabindex="-1"><a class="header-anchor" href="#视图-1"><span>视图</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api文件夹中的views文件夹的news.py</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> CreateModelMixin<span class="token punctuation">,</span> ListModelMixin</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>news <span class="token keyword">import</span> NewsSerializer<span class="token punctuation">,</span> IndexSerializer</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token keyword">import</span> SelfFilter</span>
<span class="line"><span class="token keyword">from</span> django_filters<span class="token punctuation">.</span>rest_framework <span class="token keyword">import</span> DjangoFilterBackend</span>
<span class="line"><span class="token keyword">from</span> django_filters <span class="token keyword">import</span> FilterSet<span class="token punctuation">,</span> filters</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension <span class="token keyword">import</span> throttle</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>auth <span class="token keyword">import</span> NoTokenAuthentication</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">IndexView</span><span class="token punctuation">(</span>ListModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>News<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&#39;-id&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> IndexSerializer</span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> NewsFilter</span>
<span class="line">    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span>NoTokenAuthentication<span class="token punctuation">]</span></span>
<span class="line">    </span>
<span class="line">    </span>
<span class="line">    </span>
<span class="line"><span class="token comment"># 访问</span></span>
<span class="line">get请求<span class="token punctuation">:</span></span>
<span class="line">    获取所有资讯<span class="token punctuation">:</span></span>
<span class="line">    http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>index<span class="token operator">/</span></span>
<span class="line">    限制访问两条<span class="token punctuation">:</span></span>
<span class="line">    http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>index<span class="token operator">/</span>?limit<span class="token operator">=</span><span class="token number">2</span></span>
<span class="line">    限制上次访问的位置为<span class="token number">5</span></span>
<span class="line">    http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>index<span class="token operator">/</span>?limit<span class="token operator">=</span><span class="token number">2</span><span class="token operator">&amp;</span>latest_id<span class="token operator">=</span><span class="token number">5</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="收藏" tabindex="-1"><a class="header-anchor" href="#收藏"><span>收藏</span></a></h2><h3 id="路由-5" tabindex="-1"><a class="header-anchor" href="#路由-5"><span>路由</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 在api文件夹的urls.py中写入</span></span>
<span class="line"><span class="token comment"># api.views文件夹中创建collect.py</span></span>
<span class="line">router<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&#39;collect&#39;</span><span class="token punctuation">,</span> collect<span class="token punctuation">.</span>CollectView<span class="token punctuation">,</span> <span class="token string">&#39;collect&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="序列化类-4" tabindex="-1"><a class="header-anchor" href="#序列化类-4"><span>序列化类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.serial文件夹中创建collect.py</span></span>
<span class="line"><span class="token comment"># 写入收藏相关的序列化类</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> serializers</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ValidationError</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CollectNewsSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    image_list <span class="token operator">=</span> serializers<span class="token punctuation">.</span>SerializerMethodField<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>News</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;title&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;image_list&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_image_list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> obj<span class="token punctuation">.</span>image<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">return</span> obj<span class="token punctuation">.</span>image<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CollectSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    news_info <span class="token operator">=</span> CollectNewsSerializer<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> source<span class="token operator">=</span><span class="token string">&#39;news&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Collect</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;news&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;news_info&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        extra_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;news&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;write_only&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">validate_news</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        exists <span class="token operator">=</span> models<span class="token punctuation">.</span>News<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>attrs<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> deleted<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> exists<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;资讯不存在&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> attrs</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="视图类-4" tabindex="-1"><a class="header-anchor" href="#视图类-4"><span>视图类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api文件夹中的news文件夹的collect.py</span></span>
<span class="line"><span class="token comment"># 写入收藏相关的视图</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token keyword">import</span> SelfFilter</span>
<span class="line"><span class="token keyword">from</span> django_filters<span class="token punctuation">.</span>rest_framework <span class="token keyword">import</span> DjangoFilterBackend</span>
<span class="line"><span class="token keyword">from</span> django_filters <span class="token keyword">import</span> FilterSet<span class="token punctuation">,</span> filters</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>collect <span class="token keyword">import</span> CollectSerializer</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension <span class="token keyword">import</span> return_code</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CollectFilter</span><span class="token punctuation">(</span>FilterSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    latest_id <span class="token operator">=</span> filters<span class="token punctuation">.</span>NumberFilter<span class="token punctuation">(</span>field_name<span class="token operator">=</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> lookup_expr<span class="token operator">=</span><span class="token string">&#39;le&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Collect</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;latest_id&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CollectView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>Collect<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> CollectSerializer</span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>SelfFilter<span class="token punctuation">,</span> DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> CollectFilter</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 收藏/取消收藏</span></span>
<span class="line">        user <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user</span>
<span class="line">        instance <span class="token operator">=</span> models<span class="token punctuation">.</span>Collect<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>user<span class="token punctuation">,</span> <span class="token operator">**</span>serializer<span class="token punctuation">.</span>validated_data<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> instance<span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 添加收藏,给资讯的收藏数加一</span></span>
<span class="line">            ser <span class="token operator">=</span> serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>user<span class="token punctuation">)</span></span>
<span class="line">            ser<span class="token punctuation">.</span>news<span class="token punctuation">.</span>collect_count <span class="token operator">+=</span> <span class="token number">1</span></span>
<span class="line">            ser<span class="token punctuation">.</span>news<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;active&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 有记录:删除收藏,资讯的收藏数减一</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            instance<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            instance<span class="token punctuation">.</span>news<span class="token punctuation">.</span>collect_count <span class="token operator">-=</span> <span class="token number">1</span></span>
<span class="line">            instance<span class="token punctuation">.</span>news<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;active&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line"><span class="token comment"># 访问</span></span>
<span class="line">post请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>collect<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971 <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>无则收藏<span class="token punctuation">,</span> 有则取消收藏</span>
<span class="line">  请求体<span class="token punctuation">:</span>raw</span>
<span class="line">    <span class="token builtin">id</span><span class="token punctuation">,</span> news</span>
<span class="line"></span>
<span class="line">get请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>collect<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971 <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>获取当前登录的用户的所有收藏记录</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="推荐" tabindex="-1"><a class="header-anchor" href="#推荐"><span>推荐</span></a></h2><h3 id="路由-6" tabindex="-1"><a class="header-anchor" href="#路由-6"><span>路由</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.urls.py</span></span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>views <span class="token keyword">import</span> account<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> news<span class="token punctuation">,</span> collect<span class="token punctuation">,</span> recommend</span>
<span class="line"></span>
<span class="line">router<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&#39;recommend&#39;</span><span class="token punctuation">,</span> recommend<span class="token punctuation">.</span>RecommendView<span class="token punctuation">,</span> <span class="token string">&#39;recommend&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="序列化类-5" tabindex="-1"><a class="header-anchor" href="#序列化类-5"><span>序列化类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># 推荐相关的序列化类</span></span>
<span class="line"><span class="token comment"># api.serializer文件夹中创建recommend.py写入</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> serializers</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ValidationError</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RecommendNewsSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    image_list <span class="token operator">=</span> serializers<span class="token punctuation">.</span>SerializerMethodField<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>News</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;title&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;url&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;image_list&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_image_list</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> obj<span class="token punctuation">.</span>image<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">return</span> obj<span class="token punctuation">.</span>image<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">&#39;,&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RecommendSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    news_info <span class="token operator">=</span> RecommendNewsSerializer<span class="token punctuation">(</span>read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> source<span class="token operator">=</span><span class="token string">&#39;news&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Recommend</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;news&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;news_info&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        extra_kwargs <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token string">&#39;news&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;write_only&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="视图类-5" tabindex="-1"><a class="header-anchor" href="#视图类-5"><span>视图类</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.views文件夹中创建recommend.py写入</span></span>
<span class="line"><span class="token comment"># 推荐相关的视图</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>response <span class="token keyword">import</span> Response</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension <span class="token keyword">import</span> return_code</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span><span class="token builtin">filter</span> <span class="token keyword">import</span> SelfFilter</span>
<span class="line"><span class="token keyword">from</span> django_filters<span class="token punctuation">.</span>rest_framework <span class="token keyword">import</span> DjangoFilterBackend</span>
<span class="line"><span class="token keyword">from</span> django_filters <span class="token keyword">import</span> FilterSet<span class="token punctuation">,</span> filters</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>recommend <span class="token keyword">import</span> RecommendSerializer</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>models <span class="token keyword">import</span> Recommend</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RecommendFilter</span><span class="token punctuation">(</span>FilterSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    latest_id <span class="token operator">=</span> filters<span class="token punctuation">.</span>NumberFilter<span class="token punctuation">(</span>field_name<span class="token operator">=</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> lookup_expr<span class="token operator">=</span><span class="token string">&#39;le&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> Recommend</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;latest_id&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">RecommendView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    queryset <span class="token operator">=</span> Recommend<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> RecommendSerializer</span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>SelfFilter<span class="token punctuation">,</span> DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> RecommendFilter</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        user <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user</span>
<span class="line">        instance <span class="token operator">=</span> Recommend<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>user<span class="token operator">=</span>user<span class="token punctuation">,</span> <span class="token operator">**</span>serializer<span class="token punctuation">.</span>validated_data<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> instance<span class="token punctuation">:</span></span>
<span class="line">            ser <span class="token operator">=</span> serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>user<span class="token punctuation">)</span></span>
<span class="line">            ser<span class="token punctuation">.</span>news<span class="token punctuation">.</span>recommend_count <span class="token operator">+=</span> <span class="token number">1</span></span>
<span class="line">            ser<span class="token punctuation">.</span>news<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;active&#39;</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            instance<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            instance<span class="token punctuation">.</span>news<span class="token punctuation">.</span>recommend_count <span class="token operator">-=</span> <span class="token number">1</span></span>
<span class="line">            instance<span class="token punctuation">.</span>news<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">return</span> Response<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">&#39;code&#39;</span><span class="token punctuation">:</span> return_code<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token string">&#39;data&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">&#39;active&#39;</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line">        </span>
<span class="line"><span class="token comment"># 访问:</span></span>
<span class="line">post请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>recommend<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971 <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>有则取消<span class="token punctuation">,</span>无则推荐</span>
<span class="line">   请求体<span class="token punctuation">:</span> raw</span>
<span class="line">    news</span>
<span class="line"> </span>
<span class="line">get请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>recommend<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971 <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>获取当前登录用户的所有推荐记录</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="评论" tabindex="-1"><a class="header-anchor" href="#评论"><span>评论</span></a></h2><h3 id="添加评论" tabindex="-1"><a class="header-anchor" href="#添加评论"><span>添加评论</span></a></h3><h4 id="路由-7" tabindex="-1"><a class="header-anchor" href="#路由-7"><span>路由</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.urls.py</span></span>
<span class="line"><span class="token comment"># 在api文件夹的views文件夹中创建comment.py写入评论相关的视图</span></span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>views <span class="token keyword">import</span> account<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> news<span class="token punctuation">,</span> collect<span class="token punctuation">,</span> recommend<span class="token punctuation">,</span> comment</span>
<span class="line">router<span class="token punctuation">.</span>register<span class="token punctuation">(</span><span class="token string">&#39;comment&#39;</span><span class="token punctuation">,</span> comment<span class="token punctuation">.</span>CommentView<span class="token punctuation">,</span> <span class="token string">&#39;comment&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="序列化类-6" tabindex="-1"><a class="header-anchor" href="#序列化类-6"><span>序列化类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.serializer文件夹中创建comment.py写入</span></span>
<span class="line"><span class="token comment"># 评论相关的序列化类</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework <span class="token keyword">import</span> serializers</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>exceptions <span class="token keyword">import</span> ValidationError</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CreateCommentSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token triple-quoted-string string">&#39;&#39;&#39;</span>
<span class="line">    数据校验:</span>
<span class="line">        根评论1:news, content, root=null, reply=null, depth=0</span>
<span class="line">        一级子评论1:news, content, root=reply=回复的根评论的id, depth=回复的评论的depth+1</span>
<span class="line">        二级子评论1:news, content, root=reply.root, reply=回复的评论的id, depth=回复的评论的depth+1</span>
<span class="line">    &#39;&#39;&#39;</span></span>
<span class="line">    create_datetime <span class="token operator">=</span> serializers<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token punctuation">,</span> read_only<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Comment</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;news&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;content&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;reply&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;depth&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;create_datetime&#39;</span><span class="token punctuation">]</span></span>
<span class="line">        read_only_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;depth&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">validate_news</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 因为可能在手动传参的过程中会出现回复的资讯不等于传入的资讯</span></span>
<span class="line">        reply <span class="token operator">=</span> self<span class="token punctuation">.</span>initial_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;reply&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> reply<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> attrs</span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            reply_obj <span class="token operator">=</span> models<span class="token punctuation">.</span>Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token operator">=</span>reply<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> reply_obj<span class="token punctuation">.</span>news <span class="token operator">!=</span> attrs<span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">raise</span> ValidationError<span class="token punctuation">(</span><span class="token string">&#39;评论错误!&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="视图类-6" tabindex="-1"><a class="header-anchor" href="#视图类-6"><span>视图类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.views文件夹中创建comment.py</span></span>
<span class="line"><span class="token comment"># 评论相关的视图</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">import</span> datetime</span>
<span class="line"><span class="token keyword">from</span> django_filters<span class="token punctuation">.</span>rest_framework <span class="token keyword">import</span> DjangoFilterBackend</span>
<span class="line"><span class="token keyword">from</span> django_filters <span class="token keyword">import</span> FilterSet<span class="token punctuation">,</span> filters</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>comment <span class="token keyword">import</span> CreateCommentSerializer</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CommentView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> CreateCommentSerializer</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        reply <span class="token operator">=</span> serializer<span class="token punctuation">.</span>validated_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;reply&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 基于ModelSerializer的序列化类,外键字段传递是id,但是实际获取的是对应的外键对象</span></span>
<span class="line">        <span class="token comment"># 1.根评论:news, content</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> reply<span class="token punctuation">:</span></span>
<span class="line">            instance <span class="token operator">=</span> serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 2.一级子评论:如果回复的评论没有根评论说明回复的是根评论</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token keyword">not</span> reply<span class="token punctuation">.</span>root<span class="token punctuation">:</span>  <span class="token comment"># 一级子评论.reply---&gt;根评论--&gt;根评论没有root</span></span>
<span class="line">                root <span class="token operator">=</span> reply</span>
<span class="line">            <span class="token comment"># 3.其他子评论</span></span>
<span class="line">            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 二级评论.reply---&gt;一级子评论--&gt;一级子评论.root</span></span>
<span class="line">                root <span class="token operator">=</span> reply<span class="token punctuation">.</span>root</span>
<span class="line">            <span class="token comment"># 创建评论</span></span>
<span class="line">            instance <span class="token operator">=</span> serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> depth<span class="token operator">=</span>reply<span class="token punctuation">.</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> root<span class="token operator">=</span>root<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># 更新对应的根评论的后代更新时间</span></span>
<span class="line">            root<span class="token punctuation">.</span>descendant_update_datetime <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            root<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 资讯表的评论数加一</span></span>
<span class="line">        instance<span class="token punctuation">.</span>news<span class="token punctuation">.</span>comment_count <span class="token operator">+=</span> <span class="token number">1</span></span>
<span class="line">        instance<span class="token punctuation">.</span>news<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 访问:</span></span>
<span class="line">post请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>comment<span class="token operator">/</span>?token<span class="token operator">=</span>9954d5e3<span class="token operator">-</span>afff<span class="token operator">-</span>45b1<span class="token operator">-</span>ae5c<span class="token operator">-</span>6878005f2971</span>
<span class="line">   请求体<span class="token punctuation">:</span>form<span class="token operator">-</span>data</span>
<span class="line">    news<span class="token punctuation">,</span> content <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>根评论</span>
<span class="line">    news<span class="token punctuation">,</span> content<span class="token punctuation">,</span> reply <span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>子评论</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="查看评论" tabindex="-1"><a class="header-anchor" href="#查看评论"><span>查看评论</span></a></h3><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;资讯&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;内容&#39;</span><span class="token punctuation">,</span> 子评论列表<span class="token punctuation">:</span><span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;资讯&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;内容&#39;</span><span class="token punctuation">,</span> 子评论列表<span class="token punctuation">:</span><span class="token punctuation">[</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">        </span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token punctuation">{</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;资讯&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;内容&#39;</span><span class="token punctuation">,</span> 子评论列表<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="序列化类-7" tabindex="-1"><a class="header-anchor" href="#序列化类-7"><span>序列化类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.serializer文件夹中的comment.py</span></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">ListCommentSerializer</span><span class="token punctuation">(</span>serializers<span class="token punctuation">.</span>ModelSerializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    create_time <span class="token operator">=</span> serializers<span class="token punctuation">.</span>DateTimeField<span class="token punctuation">(</span><span class="token builtin">format</span><span class="token operator">=</span><span class="token string">&#39;%Y-%m-%d %H:%M:%S&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    children <span class="token operator">=</span> serializers<span class="token punctuation">.</span>SerializerMethodField<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Comment</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;reply&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;content&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;children&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;create_time&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_children</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># obj:根评论对象</span></span>
<span class="line">        <span class="token comment"># 获取对应的根评论的子评论列表</span></span>
<span class="line">        <span class="token comment"># 获取当前根评论的所有子孙评论</span></span>
<span class="line">        sun_queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>root<span class="token operator">=</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&#39;id&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        sun_dict <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># {&#39;子孙id&#39;: {row}}</span></span>
<span class="line">        <span class="token keyword">for</span> sun_obj <span class="token keyword">in</span> sun_queryset<span class="token punctuation">:</span></span>
<span class="line">            ser <span class="token operator">=</span> CreateCommentSerializer<span class="token punctuation">(</span>instance<span class="token operator">=</span>sun_obj<span class="token punctuation">,</span> many<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></span>
<span class="line">            row <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">&#39;children&#39;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span>
<span class="line">            row<span class="token punctuation">.</span>update<span class="token punctuation">(</span>ser<span class="token punctuation">.</span>data<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># row:{&#39;id&#39;, &#39;news&#39;, &#39;content&#39;, &#39;reply&#39;, &#39;depth&#39;, &#39;create_datetime&#39;, &#39;children&#39;}</span></span>
<span class="line">            sun_dict<span class="token punctuation">[</span>sun_obj<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> row</span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 将不同级别的子孙评论对象放到对应级别的子评论列表中</span></span>
<span class="line">        children_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">        <span class="token keyword">for</span> sun_id<span class="token punctuation">,</span> row <span class="token keyword">in</span> sun_dict<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">            depth <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">&#39;depth&#39;</span><span class="token punctuation">]</span></span>
<span class="line">            <span class="token keyword">if</span> depth <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># 一级子评论</span></span>
<span class="line">                children_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">continue</span></span>
<span class="line">            reply_id <span class="token operator">=</span> row<span class="token punctuation">[</span><span class="token string">&#39;reply&#39;</span><span class="token punctuation">]</span>  <span class="token comment"># 获取当前评论对象的reply</span></span>
<span class="line">            <span class="token comment"># 获取到回复的评论的字典</span></span>
<span class="line">            reply_dict <span class="token operator">=</span> sun_dict<span class="token punctuation">[</span>reply_id<span class="token punctuation">]</span></span>
<span class="line">            <span class="token comment"># 将当前的子评论添加到回复的评论字典的子评论列表中</span></span>
<span class="line">            reply_dict<span class="token punctuation">[</span><span class="token string">&#39;children&#39;</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>row<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> children_list</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="视图类-7" tabindex="-1"><a class="header-anchor" href="#视图类-7"><span>视图类</span></a></h4><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># api.views文件夹的comment.py</span></span>
<span class="line"><span class="token comment"># 评论相关的视图</span></span>
<span class="line"><span class="token keyword">from</span> rest_framework<span class="token punctuation">.</span>viewsets <span class="token keyword">import</span> GenericViewSet</span>
<span class="line"><span class="token keyword">import</span> datetime</span>
<span class="line"><span class="token keyword">from</span> django_filters<span class="token punctuation">.</span>rest_framework <span class="token keyword">import</span> DjangoFilterBackend</span>
<span class="line"><span class="token keyword">from</span> django_filters <span class="token keyword">import</span> FilterSet<span class="token punctuation">,</span> filters</span>
<span class="line"><span class="token keyword">from</span> api <span class="token keyword">import</span> models</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>auth <span class="token keyword">import</span> TokenAuthentication<span class="token punctuation">,</span> NoTokenAuthentication</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>extension<span class="token punctuation">.</span>mixins <span class="token keyword">import</span> MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin</span>
<span class="line"><span class="token keyword">from</span> api<span class="token punctuation">.</span>serializer<span class="token punctuation">.</span>comment <span class="token keyword">import</span> CreateCommentSerializer<span class="token punctuation">,</span> ListCommentSerializer</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CommentFilter</span><span class="token punctuation">(</span>FilterSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    latest_id <span class="token operator">=</span> filters<span class="token punctuation">.</span>DateTimeFilter<span class="token punctuation">(</span>field_name<span class="token operator">=</span><span class="token string">&#39;descendant_update_datetime&#39;</span><span class="token punctuation">,</span> lookup_expr<span class="token operator">=</span><span class="token string">&#39;lt&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    news <span class="token operator">=</span> filters<span class="token punctuation">.</span>CharFilter<span class="token punctuation">(</span>field_name<span class="token operator">=</span><span class="token string">&#39;news&#39;</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> lookup_expr<span class="token operator">=</span><span class="token string">&#39;exact&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">class</span> <span class="token class-name">Meta</span><span class="token punctuation">:</span></span>
<span class="line">        model <span class="token operator">=</span> models<span class="token punctuation">.</span>Comment</span>
<span class="line">        fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">&#39;latest_id&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;news&#39;</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">CommentView</span><span class="token punctuation">(</span>MyCreateModelMixin<span class="token punctuation">,</span> MyListModelMixin<span class="token punctuation">,</span> GenericViewSet<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 获取所有根评论,根据根评论的子孙后代评论更新时间倒序排序</span></span>
<span class="line">    queryset <span class="token operator">=</span> models<span class="token punctuation">.</span>Comment<span class="token punctuation">.</span>objects<span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>depth<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>order_by<span class="token punctuation">(</span><span class="token string">&#39;-descendant_update_datetime&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    serializer_class <span class="token operator">=</span> CreateCommentSerializer</span>
<span class="line">    filter_backends <span class="token operator">=</span> <span class="token punctuation">[</span>DjangoFilterBackend<span class="token punctuation">]</span></span>
<span class="line">    filterset_class <span class="token operator">=</span> CommentFilter</span>
<span class="line">    authentication_classes <span class="token operator">=</span> <span class="token punctuation">[</span>TokenAuthentication<span class="token punctuation">,</span> <span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_serializer_class</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> ListCommentSerializer</span>
<span class="line">        <span class="token keyword">return</span> CreateCommentSerializer</span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">get_authenticators</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">if</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>method <span class="token operator">==</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get_authenticators<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>   <span class="token comment"># get请求不需要认证</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">def</span> <span class="token function">perform_create</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> serializer<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">        reply <span class="token operator">=</span> serializer<span class="token punctuation">.</span>validated_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">&#39;reply&#39;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment"># 基于ModelSerializer的序列化类,外键字段传递是id,但是实际获取的是对应的外键对象</span></span>
<span class="line">        <span class="token comment"># 1.根评论:news, content</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token keyword">not</span> reply<span class="token punctuation">:</span></span>
<span class="line">            instance <span class="token operator">=</span> serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">            <span class="token comment"># 2.一级子评论:如果回复的评论没有根评论说明回复的是根评论</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token keyword">not</span> reply<span class="token punctuation">.</span>root<span class="token punctuation">:</span>  <span class="token comment"># 一级子评论.reply---&gt;根评论--&gt;根评论没有root</span></span>
<span class="line">                root <span class="token operator">=</span> reply</span>
<span class="line">            <span class="token comment"># 3.其他子评论</span></span>
<span class="line">            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 二级评论.reply---&gt;一级子评论--&gt;一级子评论.root</span></span>
<span class="line">                root <span class="token operator">=</span> reply<span class="token punctuation">.</span>root</span>
<span class="line">            <span class="token comment"># 创建评论</span></span>
<span class="line">            instance <span class="token operator">=</span> serializer<span class="token punctuation">.</span>save<span class="token punctuation">(</span>user<span class="token operator">=</span>self<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">,</span> depth<span class="token operator">=</span>reply<span class="token punctuation">.</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> root<span class="token operator">=</span>root<span class="token punctuation">)</span></span>
<span class="line">            <span class="token comment"># 更新对应的根评论的后代更新时间</span></span>
<span class="line">            root<span class="token punctuation">.</span>descendant_update_datetime <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            root<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment"># 资讯表的评论数加一</span></span>
<span class="line">        instance<span class="token punctuation">.</span>news<span class="token punctuation">.</span>comment_count <span class="token operator">+=</span> <span class="token number">1</span></span>
<span class="line">        instance<span class="token punctuation">.</span>news<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 访问:</span></span>
<span class="line">get请求<span class="token punctuation">:</span>http<span class="token punctuation">:</span><span class="token operator">//</span>localhost<span class="token punctuation">:</span><span class="token number">8000</span><span class="token operator">/</span>api<span class="token operator">/</span>comment<span class="token operator">/</span>?news<span class="token operator">=</span><span class="token number">2</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>django:--&gt;基础:book项目, 进阶:bbs项目</p><p>linux:---&gt;部署</p><p>drf:---&gt;项目</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav" aria-label="page navigation"><a class="route-link auto-link prev" href="/book/django/38-drf%E6%A1%86%E6%9E%B6.html" aria-label="38-drf框架"><!--[--><div class="hint"><span class="arrow left"></span> Prev</div><div class="link"><span class="external-link">38-drf框架</span></div><!--]--></a><!----></nav><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/book/assets/app-D_gKCYhm.js" defer></script>
  </body>
</html>
