import{_ as s,c as a,a as p,o as e}from"./app-Cbtc5Jwy.js";const t={};function l(c,n){return e(),a("div",null,[...n[0]||(n[0]=[p(`<h1 id="粘包-网盘项目" tabindex="-1"><a class="header-anchor" href="#粘包-网盘项目"><span>粘包+网盘项目</span></a></h1><h2 id="_1-粘包" tabindex="-1"><a class="header-anchor" href="#_1-粘包"><span>1.粘包</span></a></h2><p>在socket中数据不是直接发送给对象,是将数据发送到本机操作系统的缓冲区中;接收数据也是一样的,在操作系统的缓冲区中提取数据</p><p>缓冲区可以存储少量的数据</p><h3 id="_1-1-产生粘包" tabindex="-1"><a class="header-anchor" href="#_1-1-产生粘包"><span>1.1 产生粘包</span></a></h3><p>粘包问题发生基于TCP协议的网络通信中,因为TCP是一个面向流的协议,粘包问题主要分为两种情况:</p><p>**发送方:**发送方在很短的时间内连续发送了多个数据包,这些数据包可能会在底层的TCP协议中被合并为一个数据包发送出去</p><p>**接收方:**接收方在读取数据时,没有按照发送方发送过来数据边界来读取数据,可能会把多个数据包的数据读到一起,然后使用循环进行接收所有的数据</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># socket服务端(接收方)</span></span>
<span class="line"><span class="token keyword">import</span> socket</span>
<span class="line"></span>
<span class="line">server <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">conn<span class="token punctuation">,</span>addr <span class="token operator">=</span> server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">data <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">data <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span></span>
<span class="line"><span class="token comment"># socket客户端(发送方)</span></span>
<span class="line"><span class="token keyword">import</span> socket</span>
<span class="line"></span>
<span class="line">client <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></span>
<span class="line">client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">client<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;你好呀&quot;</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">client<span class="token punctuation">.</span>send<span class="token punctuation">(</span><span class="token string">&quot;我叫小白&quot;</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-2-解决粘包" tabindex="-1"><a class="header-anchor" href="#_1-2-解决粘包"><span>1.2 解决粘包</span></a></h3><p>解决粘包问题</p><ul><li>每次发送消息时,都将消息划分为头部(固定字节长度)和数据两部分;例如:头部,用4个字节表示后面数据的长度 <ul><li>发送数据,先发送数据的长度,再发送数据(或者拼接起来再发送)</li><li>接收数据,先读取4个字节就可以知道自己这个数据包的数据长度,再根据长度读取到数据</li></ul></li></ul><p>让发送端在发送数据之前,先发数据的长度信息,让接收端知道要接收多少个数据</p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token triple-quoted-string string">&quot;&quot;&quot;</span>
<span class="line">pack() 将python基本数据类型转为字节型</span>
<span class="line">    2个参数</span>
<span class="line">        参数1:模式</span>
<span class="line">            &quot;i&quot; 表示将整数转为 4个字节</span>
<span class="line">            &quot;f&quot; 表示将浮点数转为 4个字节</span>
<span class="line">        参数2:被转数据</span>
<span class="line">    返回值:字节数据</span>
<span class="line">        </span>
<span class="line">unpack() 将字节型转为基本数据类型</span>
<span class="line">    2个参数</span>
<span class="line">        参数1不变</span>
<span class="line">        参数2:被转数据 字节数据</span>
<span class="line">    返回值:元组(数据,)</span>
<span class="line">&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> struct</span>
<span class="line"></span>
<span class="line"><span class="token comment"># struct.pack(&quot;i&quot;,数据)</span></span>
<span class="line">res <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">type</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 解码后返回的是一个元组类型,元组中的第一个元素就是原数据</span></span>
<span class="line">size <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token comment"># socket(接收方)</span></span>
<span class="line"><span class="token keyword">import</span> socket</span>
<span class="line"><span class="token keyword">import</span> struct</span>
<span class="line"></span>
<span class="line">server <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment"># 固定读取四个字节</span></span>
<span class="line">header1 <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span></span>
<span class="line">length1 <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> header1<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">data1 <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>length1<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>data1<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">header2 <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span></span>
<span class="line">length2 <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> header2<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span></span>
<span class="line">data2 <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>length2<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">print</span><span class="token punctuation">(</span>data2<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span><span class="token operator">-</span></span>
<span class="line"><span class="token comment"># socket(发送方)</span></span>
<span class="line"><span class="token keyword">import</span> socket</span>
<span class="line"><span class="token keyword">import</span> struct</span>
<span class="line"></span>
<span class="line">client <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></span>
<span class="line">client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">msg <span class="token operator">=</span> <span class="token string">&quot;你好呀&quot;</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span></span>
<span class="line">header <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">client<span class="token punctuation">.</span>send<span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token comment"># 先发四个字节表示数据的长度信息</span></span>
<span class="line">client<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">msg <span class="token operator">=</span> <span class="token string">&quot;我叫小白&quot;</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span></span>
<span class="line">header <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">client<span class="token punctuation">.</span>send<span class="token punctuation">(</span>header<span class="token punctuation">)</span></span>
<span class="line">client<span class="token punctuation">.</span>send<span class="token punctuation">(</span>msg<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>socket服务端</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> socket</span>
<span class="line"><span class="token keyword">from</span> 粘包处理函数 <span class="token keyword">import</span> <span class="token operator">*</span></span>
<span class="line"></span>
<span class="line">server <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>setsockopt<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>SOL_SOCKET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SO_REUSEADDR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="line">    conn<span class="token punctuation">,</span> addr <span class="token operator">=</span> server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">try</span><span class="token punctuation">:</span></span>
<span class="line">            data <span class="token operator">=</span> recv_data<span class="token punctuation">(</span>conn<span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">if</span> data <span class="token operator">==</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;关闭连接&quot;</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token keyword">break</span></span>
<span class="line">            <span class="token keyword">else</span><span class="token punctuation">:</span></span>
<span class="line">                <span class="token comment"># 输出数据</span></span>
<span class="line">                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;服务端接收:&quot;</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">except</span> Exception<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;意外断开&quot;</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line"></span>
<span class="line">    conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">server<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>socket客户端</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> socket</span>
<span class="line"><span class="token keyword">from</span> 粘包处理函数 <span class="token keyword">import</span> <span class="token operator">*</span></span>
<span class="line">client <span class="token operator">=</span> socket<span class="token punctuation">.</span>socket<span class="token punctuation">(</span>socket<span class="token punctuation">.</span>AF_INET<span class="token punctuation">,</span> socket<span class="token punctuation">.</span>SOCK_STREAM<span class="token punctuation">)</span></span>
<span class="line">client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span><span class="token number">9999</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span></span>
<span class="line">    msg <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">&quot;请输入内容:&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token keyword">not</span> msg<span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;请重新输入!&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">continue</span></span>
<span class="line">    send_data<span class="token punctuation">(</span>client<span class="token punctuation">,</span>msg<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> msg <span class="token operator">==</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">:</span></span>
<span class="line">        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">&quot;客户端退出&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">break</span></span>
<span class="line"></span>
<span class="line">client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>粘包处理函数</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line"><span class="token keyword">import</span> struct</span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment"># 发送数据</span></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">send_data</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 把数据先转成字节类型</span></span>
<span class="line">    data <span class="token operator">=</span> message<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 头部字节</span></span>
<span class="line">    header <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 先发头部字节</span></span>
<span class="line">    conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>header<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment"># 再发数据</span></span>
<span class="line">    conn<span class="token punctuation">.</span>send<span class="token punctuation">(</span>data<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token keyword">def</span> <span class="token function">recv_data</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> chunk_size<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token comment"># 1先读取四个字节得到数据长度</span></span>
<span class="line">    has_read_size <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    header <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span></span>
<span class="line">    <span class="token keyword">while</span> has_read_size <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">:</span></span>
<span class="line">        chunk <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">-</span> has_read_size<span class="token punctuation">)</span></span>
<span class="line">        has_read_size <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span></span>
<span class="line">        header <span class="token operator">+=</span> chunk</span>
<span class="line">    <span class="token comment"># 解码获取第一个值,也就是接收数据的长度</span></span>
<span class="line">    data_length <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack<span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token comment"># 4097</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment"># 2.接收数据</span></span>
<span class="line">    <span class="token comment"># 已经接收的长度</span></span>
<span class="line">    has_read_data_size <span class="token operator">=</span> <span class="token number">0</span></span>
<span class="line">    <span class="token comment"># 将接收的每段内容进行拼接</span></span>
<span class="line">    data <span class="token operator">=</span> <span class="token string">b&quot;&quot;</span></span>
<span class="line">    <span class="token comment"># 循环接收内容,如果已经接收的长度等于数据的长度,就退出循环</span></span>
<span class="line">    <span class="token keyword">while</span> has_read_data_size <span class="token operator">&lt;</span> data_length<span class="token punctuation">:</span></span>
<span class="line">        <span class="token comment"># 数据长度减去已经接收长度大于1024,那么下次继续接收1024个字节,如果小于1024,那么就只接收剩下的字节</span></span>
<span class="line">        size <span class="token operator">=</span> chunk_size <span class="token keyword">if</span> data_length <span class="token operator">-</span> has_read_data_size <span class="token operator">&gt;</span> chunk_size <span class="token keyword">else</span> data_length <span class="token operator">-</span> has_read_data_size</span>
<span class="line">        <span class="token comment"># 根据上一行来选择接收的大小</span></span>
<span class="line">        chunk <span class="token operator">=</span> conn<span class="token punctuation">.</span>recv<span class="token punctuation">(</span>size<span class="token punctuation">)</span></span>
<span class="line">        has_read_data_size <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span></span>
<span class="line">        data <span class="token operator">+=</span> chunk</span>
<span class="line">    <span class="token keyword">return</span> data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">&#39;utf-8&#39;</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-简易网盘系统项目" tabindex="-1"><a class="header-anchor" href="#_2-简易网盘系统项目"><span>2.简易网盘系统项目</span></a></h2><p>基于TCP协议实现一个网盘系统，包含客户端，服务端，各自需求如下：</p><ul><li><p>客户端</p><ul><li>(register)用户注册，注册成功后，在服务端的指定目录下为此用户创建一个文件夹，该文件夹下以后存储当前用户 的文件（类似于网盘）</li><li>(login)用户登录</li><li>(ls)查看网盘目录下的所有文件（一级即可）</li><li>(upload)上传文件，如果网盘已存在则重新上传（覆盖）</li><li>(download)下载文件</li></ul></li><li><p>服务端</p><ul><li>支持注册，并为用户初始化相关目录，注册成功之后，将用户的账号以及密码存储到特定的文件夹下</li><li>支持登录</li><li>支持查看当前用户网盘目录下的所有文件</li><li>支持上传</li><li>支持下载</li></ul></li></ul><p><strong>项目环境的搭建</strong></p><div class="language-python line-numbers-mode" data-highlighter="prismjs" data-ext="py"><pre><code><span class="line">设置目录结构</span>
<span class="line"><span class="token number">1.</span>建立config文件夹<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>配置信息</span>
<span class="line">	setting<span class="token punctuation">.</span>py</span>
<span class="line"><span class="token number">2.</span>建立db文件夹<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>用户账号和密码信息存放</span>
<span class="line"><span class="token number">3.</span>建立files文件夹<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>用户网盘文件</span>
<span class="line"><span class="token number">4.</span>建立src文件夹<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>核心功能文件</span>
<span class="line">	server<span class="token punctuation">.</span>py socket服务端</span>
<span class="line">    pan<span class="token punctuation">.</span>py 业务逻辑处理</span>
<span class="line"><span class="token number">5.</span>建立utils文件夹<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>存放工具类的函数</span>
<span class="line">	req<span class="token punctuation">.</span>py 请求<span class="token punctuation">:</span>发送<span class="token operator">/</span>接收</span>
<span class="line"><span class="token number">6</span><span class="token punctuation">.</span>main<span class="token punctuation">.</span>py<span class="token operator">-</span><span class="token operator">-</span><span class="token operator">&gt;</span>主程序</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,26)])])}const i=s(t,[["render",l]]),u=JSON.parse('{"path":"/python/24_%E7%B2%98%E5%8C%85_%E7%BD%91%E7%9B%98%E9%A1%B9%E7%9B%AE.html","title":"粘包+网盘项目","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"1.粘包","slug":"_1-粘包","link":"#_1-粘包","children":[{"level":3,"title":"1.1 产生粘包","slug":"_1-1-产生粘包","link":"#_1-1-产生粘包","children":[]},{"level":3,"title":"1.2 解决粘包","slug":"_1-2-解决粘包","link":"#_1-2-解决粘包","children":[]}]},{"level":2,"title":"2.简易网盘系统项目","slug":"_2-简易网盘系统项目","link":"#_2-简易网盘系统项目","children":[]}],"git":{},"filePathRelative":"python/24_粘包+网盘项目.md"}');export{i as comp,u as data};
